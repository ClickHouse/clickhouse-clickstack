"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1021],{2615:(e,t,a)=>{var n=a(60302);a(55754),a(67505),n.a,t.YR=n.e,n.b,n.d,t.bn=n.c},3145:(e,t,a)=>{var n=a(37823);a(60302),a(55754),a(67505),t.qs=n.F,n.H,n.G,t.yb=n.K,n.I,t.VO=n.J},6876:(e,t,a)=>{a.d(t,{Ay:()=>m,Q5:()=>c});var n=a(81278),r=a.n(n),i=a(62910),s=a(16932),o=a(12482),l=a(98142);let u=i.Ay.create({prefixUrl:"/api",credentials:"include",hooks:{afterResponse:[function(e,t,a){if(!["/","/forgot","/join-team","/login","/register","/reset-password"].includes(r().pathname)&&401===a.status){try{window.sessionStorage.setItem("hdx-login-redirect-url",r().asPath)}catch(e){console.error(e)}r().push("/login")}}]},timeout:!1}),c=(e,t)=>u(e,{...t}),m={useCreateAlert:()=>(0,s.n)({mutationFn:async e=>u("alerts",{method:"POST",json:e}).json()}),useUpdateAlert:()=>(0,s.n)({mutationFn:async e=>u(`alerts/${e.id}`,{method:"PUT",json:e}).json()}),useDeleteAlert:()=>(0,s.n)({mutationFn:async e=>u(`alerts/${e}`,{method:"DELETE"})}),useSilenceAlert:()=>(0,s.n)({mutationFn:async({alertId:e,mutedUntil:t})=>u(`alerts/${e}/silenced`,{method:"POST",json:{mutedUntil:t}})}),useUnsilenceAlert:()=>(0,s.n)({mutationFn:async e=>u(`alerts/${e}/silenced`,{method:"DELETE"})}),useDashboards:e=>(0,o.I)({queryKey:["dashboards"],queryFn:()=>l.VO?null:c("dashboards",{method:"GET"}).json(),...e}),useCreateDashboard:()=>(0,s.n)({mutationFn:async({name:e,charts:t,query:a,tags:n})=>c("dashboards",{method:"POST",json:{name:e,charts:t,query:a,tags:n}}).json()}),useUpdateDashboard:()=>(0,s.n)({mutationFn:async({id:e,name:t,charts:a,query:n,tags:r})=>c(`dashboards/${e}`,{method:"PUT",json:{name:t,charts:a,query:n,tags:r}}).json()}),useDeleteDashboard:()=>(0,s.n)({mutationFn:async({id:e})=>c(`dashboards/${e}`,{method:"DELETE"}).json()}),usePresetDashboardFilters:(e,t,a=!0)=>(0,o.I)({queryKey:["dashboards","preset",e,"filters",t],queryFn:()=>c(`dashboards/preset/${e}/filters/`,{method:"GET",searchParams:{sourceId:t}}).json(),enabled:!!t&&a}),useCreatePresetDashboardFilter:()=>(0,s.n)({mutationFn:async e=>c(`dashboards/preset/${e.presetDashboard}/filter`,{method:"POST",json:{filter:e}}).json()}),useUpdatePresetDashboardFilter:()=>(0,s.n)({mutationFn:async e=>c(`dashboards/preset/${e.presetDashboard}/filter`,{method:"PUT",json:{filter:e}}).json()}),useDeletePresetDashboardFilter:()=>(0,s.n)({mutationFn:async({id:e,presetDashboard:t})=>c(`dashboards/preset/${t}/filter/${e}`,{method:"DELETE"}).json()}),useAlerts:()=>(0,o.I)({queryKey:["alerts"],queryFn:()=>c("alerts").json()}),useServices:()=>(0,o.I)({queryKey:["services"],queryFn:()=>c("chart/services",{method:"GET"}).json()}),useRotateTeamApiKey:()=>(0,s.n)({mutationFn:async()=>c("team/apiKey",{method:"PATCH"}).json()}),useDeleteTeamMember:()=>(0,s.n)({mutationFn:async({userId:e})=>c(`team/member/${e}`,{method:"DELETE"}).json()}),useTeamInvitations:()=>(0,o.I)({queryKey:["team/invitations"],queryFn:()=>c("team/invitations").json()}),useSaveTeamInvitation:()=>(0,s.n)({mutationFn:async({name:e,email:t})=>c("team/invitation",{method:"POST",json:{name:e,email:t}}).json()}),useDeleteTeamInvitation:()=>(0,s.n)({mutationFn:async({id:e})=>c(`team/invitation/${e}`,{method:"DELETE"}).json()}),useInstallation:()=>(0,o.I)({queryKey:["installation"],queryFn:()=>{if(!l.VO)return c("installation").json()}}),useMe:()=>(0,o.I)({queryKey:["me"],queryFn:()=>l.VO?null:c("me").json()}),useTeam:()=>(0,o.I)({queryKey:["team"],queryFn:()=>l.VO?null:c("team").json(),retry:1}),useTeamMembers:()=>(0,o.I)({queryKey:["team/members"],queryFn:()=>c("team/members").json()}),useSetTeamName:()=>(0,s.n)({mutationFn:async({name:e})=>c("team/name",{method:"PATCH",json:{name:e}}).json()}),useUpdateClickhouseSettings:()=>(0,s.n)({mutationFn:async e=>c("team/clickhouse-settings",{method:"PATCH",json:e}).json()}),useTags:()=>(0,o.I)({queryKey:["team/tags"],queryFn:()=>c("team/tags").json()}),useSaveWebhook:()=>(0,s.n)({mutationFn:async({service:e,url:t,name:a,description:n,queryParams:r,headers:i,body:s})=>c("webhooks",{method:"POST",json:{name:a,service:e,url:t,description:n,queryParams:r||{},headers:i||{},body:s}}).json()}),useUpdateWebhook:()=>(0,s.n)({mutationFn:async({id:e,service:t,url:a,name:n,description:r,queryParams:i,headers:s,body:o})=>c(`webhooks/${e}`,{method:"PUT",json:{name:n,service:t,url:a,description:r,queryParams:i||{},headers:s||{},body:o}}).json()}),useWebhooks:e=>(0,o.I)({queryKey:[...e],queryFn:()=>c("webhooks",{method:"GET",searchParams:[...e.map(e=>["service",e])]}).json()}),useDeleteWebhook:()=>(0,s.n)({mutationFn:async({id:e})=>c(`webhooks/${e}`,{method:"DELETE"}).json()}),useTestWebhook:()=>(0,s.n)({mutationFn:async({service:e,url:t,queryParams:a,headers:n,body:r})=>c("webhooks/test",{method:"POST",json:{service:e,url:t,queryParams:a||{},headers:n||{},body:r}}).json()}),useRegisterPassword:()=>(0,s.n)({mutationFn:async({email:e,password:t,confirmPassword:a})=>c("register/password",{method:"POST",json:{email:e,password:t,confirmPassword:a}}).json()}),useTestConnection:()=>(0,s.n)({mutationFn:async({host:e,username:t,password:a})=>c("clickhouse-proxy/test",{method:"POST",json:{host:e,username:t,password:a}}).json()})}},7565:(e,t,a)=>{a.d(t,{H:()=>l,a:()=>o});var n=a(6029),r=a(75155);a(55729);var i=a(76089),s=a(57820);let o=()=>{let e,t=(0,r.c)(3),{userPreferences:a}=(0,s.HW)(),{isUTC:n,timeFormat:o}=a;return t[0]!==n||t[1]!==o?(e=(e,t)=>{let{format:a}=void 0===t?{}:t;try{let t=e instanceof Date?e:new Date(e);return(0,i.Yq)(t,{clock:o,isUTC:n,format:a})}catch(t){return console.error(t,e),"Unknown date"}},t[0]=n,t[1]=o,t[2]=e):e=t[2],e},l=e=>{let t,a,i=(0,r.c)(6),{value:s,format:l}=e,u=o();return s?(i[0]!==l||i[1]!==u||i[2]!==s?(t=u(s,{format:l}),i[0]=l,i[1]=u,i[2]=s,i[3]=t):t=i[3],i[4]!==t?(a=(0,n.jsx)(n.Fragment,{children:t}),i[4]=t,i[5]=a):a=i[5],a):null}},9897:(e,t,a)=>{a.d(t,{h:()=>r});var n,r=((n={})[n.Pending=1]="Pending",n[n.Running=2]="Running",n[n.Succeeded=3]="Succeeded",n[n.Failed=4]="Failed",n[n.Unknown=5]="Unknown",n)},35467:(e,t,a)=>{var n=a(37823);a(60302),a(55754),a(67505),n.y,t.p1=n.u,t.A2=n.l,t.kg=n.r,t.D7=n.B,n.w,n.x,n.s,t.rj=n.n,n.q,t.bZ=n.v,n.p,t.P1=n.C,n.m,n.E,t.zo=n.D,t.Zo=n.o,t.l6=n.A,t.k$=n.z,n.t},35871:(e,t,a)=>{a.d(t,{A:()=>u});var n=a(6029),r=a(75155),i=a(76089),s=a(63085),o=a(45749),l=a(7565);function u(e){let t,a,u,c,m,d=(0,r.c)(12),{originalDateRange:p,effectiveDateRange:g,mvGranularity:h}=e,f=(0,l.a)();if(!g||(0,i._p)(g,p))return null;d[0]!==g[0]||d[1]!==f?(t=f(g[0]),d[0]=g[0],d[1]=f,d[2]=t):t=d[2],d[3]!==g[1]||d[4]!==f?(a=f(g[1]),d[3]=g[1],d[4]=f,d[5]=a):a=d[5],d[6]!==t||d[7]!==a?(u=[t,a],d[6]=t,d[7]=a,d[8]=u):u=d[8];let[y,E]=u,A=h?`Querying ${y} - ${E} due to ${h} rollups in query acceleration.`:`Querying ${y} - ${E} to show complete intervals.`;return d[9]===Symbol.for("react.memo_cache_sentinel")?(c=(0,n.jsx)(o.A,{size:16,color:"var(--color-text)"}),d[9]=c):c=d[9],d[10]!==A?(m=(0,n.jsx)(s.m,{multiline:!0,maw:500,label:A,children:c}),d[10]=A,d[11]=m):m=d[11],m}},37823:(e,t,a)=>{let n;function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t.default=e,t}function i(e){return e&&e.__esModule?e:{default:e}}function s(e,t){return null!=e?e:t()}function o(e){let t,a=e[0],n=1;for(;n<e.length;){let r=e[n],i=e[n+1];if(n+=2,("optionalAccess"===r||"optionalCall"===r)&&null==a)return;"access"===r||"optionalAccess"===r?(t=a,a=i(a)):("call"===r||"optionalCall"===r)&&(a=i((...e)=>a.call(t,...e)),t=void 0)}return a}Object.defineProperty(t,"__esModule",{value:!0});var l,u,c,m=a(60302),d=a(55754),p=a(67505),g=a(64497),h=r(g),f=r(g),y=i(a(79339)),E=i(a(64022)),A=i(a(80519)),N=i(a(55235)),T=a(71434),S=t.G=l=class{constructor(){l.prototype.__init.call(this),l.prototype.__init2.call(this)}__init(){this.cache=new Map}__init2(){this.pendingQueries=new Map}get(e){return this.cache.get(e)}async getOrFetch(e,t){let a=this.cache.get(e);if(null!=a)return a;if(this.pendingQueries.has(e))return this.pendingQueries.get(e);let n=t();this.pendingQueries.set(e,n);try{let t=await n;return this.cache.set(e,t),t}finally{this.pendingQueries.delete(e)}}set(e,t){return this.cache.set(e,t)}},_=t.H=class{constructor(e,t,a){this.clickhouseClient=e,this.cache=t,a&&this.cache.set("clickhouse-settings",a)}getClickHouseSettings(){return s(this.cache.get("clickhouse-settings"),()=>({}))}setClickHouseSettings(e){let t={...this.getClickHouseSettings(),...e};this.cache.set("clickhouse-settings",t)}async queryTableMetadata({database:e,table:t,cache:a,connectionId:n}){return a.getOrFetch(`${n}.${e}.${t}.metadata`,async()=>{let a=eT`SELECT * FROM system.tables where database = ${{String:e}} AND name = ${{String:t}}`;return(await this.clickhouseClient.query({connectionId:n,query:a.sql,query_params:a.params,clickhouse_settings:this.getClickHouseSettings()}).then(e=>e.json())).data[0]})}async queryMaterializedViewsByTarget({databaseName:e,tableName:t,connectionId:a}){return this.cache.getOrFetch(`${a}.${e}.${t}.sourceMaterializedViews`,async()=>{let n=`%TO ${e}.${t}%`,r=eT`
          SELECT database as databaseName, name as tableName
          FROM system.tables
          WHERE engine = 'MaterializedView' 
            AND create_table_query LIKE ${{String:n}}`;return(await this.clickhouseClient.query({connectionId:a,query:r.sql,query_params:r.params,clickhouse_settings:this.getClickHouseSettings()}).then(e=>e.json())).data})}async getColumns({databaseName:e,tableName:t,connectionId:a}){return this.cache.getOrFetch(`${a}.${e}.${t}.columns`,async()=>{let n=eT`DESCRIBE ${ex({database:e,table:t})}`;return await this.clickhouseClient.query({query:n.sql,query_params:n.params,connectionId:a,clickhouse_settings:this.getClickHouseSettings()}).then(e=>e.json()).then(e=>e.data)})}async getMaterializedColumnsLookupTable({databaseName:e,tableName:t,connectionId:a}){return new Map((await this.getColumns({databaseName:e,tableName:t,connectionId:a})).filter(e=>"MATERIALIZED"===e.default_type||"DEFAULT"===e.default_type).map(e=>[e.default_expression,e.name]))}async getColumn({databaseName:e,tableName:t,column:a,matchLowercase:n=!1,connectionId:r}){return(await this.getColumns({databaseName:e,tableName:t,connectionId:r})).filter(e=>n?e.name.toLowerCase()===a.toLowerCase():e.name===a)[0]}async getMapKeys({databaseName:e,tableName:t,column:a,maxKeys:n=1e3,connectionId:r,metricName:i}){let o=i?`${r}.${e}.${t}.${a}.${i}.keys`:`${r}.${e}.${t}.${a}.keys`,l=this.cache.get(o);if(null!=l)return l;let u=await this.getColumn({databaseName:e,tableName:t,column:a,connectionId:r});if(null==u)throw Error(`Column ${a} not found in ${e}.${t}`);let c="groupUniqArrayArray";u.type.startsWith("Map(LowCardinality(String)")&&(c="lowCardinalityKeys");let m=i?eT`WHERE MetricName=${{String:i}}`:"",d;return d="groupUniqArrayArray"===c?eT`
        WITH sampledKeys as (
          SELECT ${{Identifier:a}}.keys AS keys
          FROM ${ex({database:e,table:t})} ${m}
          LIMIT ${{Int32:this.getClickHouseSettings().max_rows_to_read?Number(this.getClickHouseSettings().max_rows_to_read):3e6}}
        )
        SELECT groupUniqArrayArray(${{Int32:n}})(keys) as keysArr
        FROM sampledKeys`:eT`
        WITH sampledKeys as (
          SELECT ${{Identifier:a}}.keys AS keysArr
          FROM ${ex({database:e,table:t})} ${m}
          LIMIT ${{Int32:this.getClickHouseSettings().max_rows_to_read?Number(this.getClickHouseSettings().max_rows_to_read):3e6}}
        )
        SELECT DISTINCT lowCardinalityKeys(arrayJoin(keysArr)) as key
        FROM sampledKeys
        LIMIT ${{Int32:n}}
      `,this.cache.getOrFetch(o,async()=>await this.clickhouseClient.query({query:d.sql,query_params:d.params,connectionId:r,clickhouse_settings:{...this.getClickHouseSettings(),timeout_overflow_mode:"break",max_execution_time:15,max_rows_to_read:"0"}}).then(e=>e.json()).then(e=>("groupUniqArrayArray"===c?s(e.data[0].keysArr,()=>[]):e.data.map(e=>e.key).filter(e=>!!e)).filter(e=>e)))}async getJSONKeys({column:e,maxKeys:t=1e3,databaseName:a,tableName:n,connectionId:r,metricName:i}){return[]}async getMapValues({databaseName:e,tableName:t,column:a,key:n,maxValues:r=20,connectionId:i}){let o=`${i}.${e}.${t}.${a}.${n}.values`,l=this.cache.get(o);if(null!=l)return l;let u=n?eT`
      SELECT DISTINCT ${{Identifier:a}}[${{String:n}}] as value
      FROM ${ex({database:e,table:t})}
      WHERE value != ''
      LIMIT ${{Int32:r}}
    `:eT`
      SELECT DISTINCT ${{Identifier:a}} as value
      FROM ${ex({database:e,table:t})}
      WHERE value != ''
      LIMIT ${{Int32:r}}
    `;return this.cache.getOrFetch(o,async()=>await this.clickhouseClient.query({query:u.sql,query_params:u.params,connectionId:i,clickhouse_settings:{max_rows_to_read:String(s(this.getClickHouseSettings().max_rows_to_read,()=>3e6)),read_overflow_mode:"break",...this.getClickHouseSettings()}}).then(e=>e.json()).then(e=>e.data.map(e=>e.value)))}async getAllFields({databaseName:e,tableName:t,connectionId:a,metricName:n}){let r=[],i=await this.getColumns({databaseName:e,tableName:t,connectionId:a});for(let e of i)"JSON"!==e.type&&r.push({path:[e.name],type:e.type,jsType:ef(e.type)});let l=s(ev(i,["map","json"]),()=>[]);return await Promise.all(l.map(async i=>{if("json"===ef(i.type)){for(let s of(await this.getJSONKeys({databaseName:e,tableName:t,column:i.name,connectionId:a,metricName:n})))r.push({path:[i.name,s.key],type:s.chType,jsType:ef(s.chType)});return}let l=await this.getMapKeys({databaseName:e,tableName:t,column:i.name,connectionId:a,metricName:n}),u=s(o([i,"access",e=>e.type,"access",e=>e.match,"call",e=>e(/Map\(.+,\s*(.+)\)/),"optionalAccess",e=>e[1]]),()=>"String");for(let e of l)r.push({path:[i.name,e],type:u,jsType:ef(u)})})),r}async getTableMetadata({databaseName:e,tableName:t,connectionId:a}){let n=await this.queryTableMetadata({cache:this.cache,database:e,table:t,connectionId:a});return n.partition_key.startsWith("(")&&n.partition_key.endsWith(")")&&(n.partition_key=n.partition_key.slice(1,-1)),n}async getSetting({settingName:e,connectionId:t}){return this.cache.getOrFetch(`${t}.${e}`,async()=>{let a=eT`
          SELECT name, value
          FROM system.settings
          WHERE name = ${{String:e}}
        `;try{let e=await this.clickhouseClient.query({connectionId:t,query:a.sql,query_params:a.params,clickhouse_settings:this.getClickHouseSettings()}).then(e=>e.json());return e.data.length>0?e.data[0].value:void 0}catch(e){if(e instanceof Error&&e.message.includes("Not enough privileges"))return void console.warn("Not enough privileges to fetch settings:",e);throw e}})}async getSkipIndices({databaseName:e,tableName:t,connectionId:a}){return this.cache.getOrFetch(`${a}.${e}.${t}.skipIndices`,async()=>{let n=eT`
          SELECT
            name,
            type,
            type_full as typeFull,
            expr as expression,
            granularity
          FROM system.data_skipping_indices
          WHERE database = ${{String:e}}
            AND table = ${{String:t}}
        `;try{return(await this.clickhouseClient.query({connectionId:a,query:n.sql,query_params:n.params,clickhouse_settings:this.getClickHouseSettings()}).then(e=>e.json())).data}catch(e){if(e instanceof Error&&e.message.includes("Not enough privileges"))return console.warn("Not enough privileges to fetch skip indices:",e),[];throw e}})}async getOtelTables({connectionId:e}){return this.cache.getOrFetch(`${e}.otelTables`,async()=>{let t=["otel_logs","otel_traces","hyperdx_sessions","otel_metrics_gauge","otel_metrics_sum","otel_metrics_summary","otel_metrics_histogram","otel_metrics_exp_histogram"].map(e=>eT`${{String:e}}`),a=eT`
          SELECT
            database,
            name
          FROM system.tables
          WHERE (database != 'system')
            AND (name IN (${eS(",",t)}))
          ORDER BY database, name
        `;try{let t=await this.clickhouseClient.query({connectionId:e,query:a.sql,query_params:a.params,clickhouse_settings:this.getClickHouseSettings()}).then(e=>e.json());if(0===t.data.length)return null;let n=new Map;for(let e of t.data)n.has(e.database)||n.set(e.database,new Set),n.get(e.database).add(e.name);let r="",i=0;for(let[e,t]of n.entries()){let a=0;t.has("otel_logs")&&(a+=10),t.has("otel_traces")&&(a+=10),t.has("hyperdx_sessions")&&(a+=5),t.has("otel_metrics_gauge")&&(a+=2),t.has("otel_metrics_sum")&&(a+=2),t.has("otel_metrics_histogram")&&(a+=2),t.has("otel_metrics_summary")&&(a+=1),t.has("otel_metrics_exp_histogram")&&(a+=1),a>i&&(i=a,r=e)}if(!r)return null;let s=n.get(r);return{database:r,tables:{logs:s.has("otel_logs")?"otel_logs":void 0,traces:s.has("otel_traces")?"otel_traces":void 0,sessions:s.has("hyperdx_sessions")?"hyperdx_sessions":void 0,metrics:{gauge:s.has("otel_metrics_gauge")?"otel_metrics_gauge":void 0,sum:s.has("otel_metrics_sum")?"otel_metrics_sum":void 0,summary:s.has("otel_metrics_summary")?"otel_metrics_summary":void 0,histogram:s.has("otel_metrics_histogram")?"otel_metrics_histogram":void 0,expHistogram:s.has("otel_metrics_exp_histogram")?"otel_metrics_exp_histogram":void 0}}}}catch(e){if(e instanceof Error&&e.message.includes("Not enough privileges"))return console.warn("Not enough privileges to fetch tables:",e),null;throw e}})}static parseTokensExpression(e){let t=e.trim().match(/^tokens\s*\((.*)\)$/i);return t?{hasTokens:!0,innerExpression:t[1].trim()}:{hasTokens:!1}}async getValuesDistribution({chartConfig:e,key:t,samples:a=1e5,limit:n=100,source:r}){let i=T.pick.call(void 0,e,["connection","from","dateRange","filters","where","with"]);return this.cache.getOrFetch(`${d.G.call(void 0,i)}.${t}.valuesDistribution`,async()=>{let i={...e,with:[...e.with||[],{name:"tableStats",chartConfig:{...T.omit.call(void 0,e,["with","groupBy","orderBy","limit"]),select:`count() as total, greatest(CAST(total / ${a} AS UInt32), 1) as sample_factor`}}],filters:[...e.filters||[],{type:"sql",condition:`cityHash64(${e.timestampValueExpression}, rand()) % (SELECT sample_factor FROM tableStats) = 0`}],select:`${t} AS __hdx_value, count() as __hdx_count, __hdx_count / (sum(__hdx_count) OVER ()) * 100 AS __hdx_percentage`,orderBy:"__hdx_percentage DESC",groupBy:"__hdx_value",limit:{limit:n}},s=await ep(i,this,o([r,"optionalAccess",e=>e.querySettings]));return new Map((await this.clickhouseClient.query({query:s.sql,query_params:s.params,connectionId:e.connection,clickhouse_settings:{...this.getClickHouseSettings(),max_rows_to_group_by:`${10*n}`,group_by_overflow_mode:"any",max_rows_to_read:"0"}}).then(e=>e.json())).data.map(({__hdx_value:e,__hdx_percentage:t})=>[e,Number(t)]))})}async getKeyValues({chartConfig:e,keys:t,limit:a=20,disableRowLimit:n=!1,signal:r,source:i}){let s={...T.pick.call(void 0,e,["connection","from","dateRange","where","with","filters"]),keys:t,disableRowLimit:n};return this.cache.getOrFetch(`${d.G.call(void 0,s)}.getKeyValues`,async()=>{if(0===t.length)return[];let s=n?{...e,select:t.map((e,t)=>`groupUniqArray(${a})(${e}) AS param${t}`).join(", ")}:await (async()=>{let n=t.map((e,t)=>`${e} as param${t}`).join(", ")||"*";return{with:[{name:"sampledData",chartConfig:{...e,select:n,limit:{limit:this.getClickHouseSettings().max_rows_to_read?Number(this.getClickHouseSettings().max_rows_to_read):3e6}},isSubquery:!0}],select:t.map((e,t)=>`groupUniqArray(${a})(param${t}) AS param${t}`).join(", "),connection:e.connection,from:{databaseName:"",tableName:"sampledData"},where:""}})(),l=await ep(s,this,o([i,"optionalAccess",e=>e.querySettings]));return Object.entries(o([await this.clickhouseClient.query({query:l.sql,query_params:l.params,connectionId:e.connection,clickhouse_settings:n?void 0:{...this.getClickHouseSettings(),timeout_overflow_mode:"break",max_execution_time:15,max_rows_to_read:"0"},abort_signal:r}).then(e=>e.json()),"optionalAccess",e=>e.data,"optionalAccess",e=>e[0]])).map(([e,a])=>({key:t[parseInt(e.replace("param",""))],value:o([a,"optionalAccess",e=>e.filter,"call",e=>e(e=>null!=e&&""!==e)])}))})}async getKeyValuesWithMVs({chartConfig:e,keys:t,source:a,limit:n=20,disableRowLimit:r,signal:i}){let s={...T.pick.call(void 0,e,["connection","from","dateRange","where","with","filters"]),keys:t,disableRowLimit:r};return this.cache.getOrFetch(`${d.G.call(void 0,s)}.getKeyValuesWithMVs`,async()=>{if(0===t.length)return[];let s=a?await m.e.call(void 0,{chartConfig:e,keys:t,source:a,clickhouseClient:this.clickhouseClient,metadata:this,signal:i}):[{chartConfig:e,keys:t}];return(await Promise.all(s.map(async({chartConfig:e,keys:t})=>this.getKeyValues({chartConfig:e,keys:t,limit:n,disableRowLimit:r,signal:i,source:a})))).flat()})}},R=new S,b=t.K=e=>new _(e,R);function C(e){return e.replace(/\\"/g,'"').replace(/HDX_BACKSLASH_LITERAL/g,"\\").replace("http_COLON_//","http://").replace("https_COLON_//","https://").replace(/localhost_COLON_(\d{1,5})/,"localhost:$1").replace(/HDX_COLON/g,":")}function w(e){return N.default.parse(e.replace(/\\\\/g,"HDX_BACKSLASH_LITERAL").replace("http://","http_COLON_//").replace("https://","https_COLON_//").replace(/localhost:(\d{1,5})/,"localhost_COLON_$1").replace(/\\:/g,"HDX_COLON"))}function I(e){let t=(e=>{let t=e.indexOf("['");if(-1!==t)return{map:e.slice(0,t),key:e.slice(t+2,-2)}})(e);if(t)return A.default.format("mapContains(??, ?)",[t.map,t.key])}var $="<implicit>";function x(e){return"term"in e&&null!=e.term}function O(e){return"inclusive"in e&&null!=e.inclusive}var v=["Int8","Int16","Int32","Int64","Int128","Int256","UInt8","UInt16","UInt32","UInt64","UInt128","UInt256","Float32","Float64"];async function L({field:e,metadata:t,databaseName:a,tableName:n,connectionId:r}){let i=e.split("."),s="";for(let e of i){s=s?`${s}.${e}`:e;let i=await t.getColumn({databaseName:a,tableName:n,column:s,connectionId:r});if(i)return i}}var F=class{constructor({metadata:e,databaseName:t,tableName:a,connectionId:n}){this.metadata=e,this.databaseName=t,this.tableName=a,this.connectionId=n}translateField(e,t){return e===$?s(t.implicitColumnExpression,()=>"event"):`'${e}'`}async getFieldType(e){let t=await L({field:e,metadata:this.metadata,databaseName:this.databaseName,tableName:this.tableName,connectionId:this.connectionId}),a=e.split(".").slice(t?t.name.split(".").length:0).join(".");if(!t)return{isArray:!1,type:null};let n=ef(t.type),r="array"===n;return r&&eE(t.type)&&(n=eE(t.type)),{isArray:r,type:n,fieldPostfix:a,column:t.name}}operator(e){switch(e){case"NOT":case"AND NOT":return"AND NOT";case"OR NOT":return"OR NOT";case"&&":case"<implicit>":case"AND":return"AND";case"||":case"OR":return"OR";default:throw Error(`Unexpected operator. ${e}`)}}async eq(e,t,a,n){let{isArray:r}=await this.getFieldType(e);return`${this.translateField(e,n)} ${r?a?"does not contain":"contains":a?"is not":"is"} ${t}`}async isNotNull(e,t,a){let{isArray:n,type:r,fieldPostfix:i,column:s}=await this.getFieldType(e);return s&&n&&("map"===r||"json"===r)&&i?`${this.translateField(s,a)} ${t?`does not contain an element with non-null ${i}`:`contains an element with non-null ${i}`}`:`${this.translateField(e,a)} ${t?"is null":"is not null"}`}async gte(e,t,a){return`${this.translateField(e,a)} is greater than or equal to ${t}`}async lte(e,t,a){return`${this.translateField(e,a)} is less than or equal to ${t}`}async lt(e,t,a){return`${this.translateField(e,a)} is less than ${t}`}async gt(e,t,a){return`${this.translateField(e,a)} is greater than ${t}`}async fieldSearch(e,t,a,n,r,i){let s=t.trim().match(/\s/)?`"${t}"`:t;if(e===$){let t=!i.implicitColumnExpression;return`${this.translateField(e,i)} ${n&&r?a?"does not contain":"contains":n?a?"does not end with":"ends with":r?a?"does not start with":"starts with":t?a?"does not have whole word":"has whole word":a?"does not contain":"contains"} ${s}`}{let{isArray:t,type:n,column:r,fieldPostfix:o}=await this.getFieldType(e),l=t&&("map"===n||"json"===n),u=l&&r?r:e;return`${this.translateField(u,i)} ${l?a?`does not contain an element with key ${o} and value`:`contains an element with key ${o} and value`:t&&"bool"!==n&&"number"!==n?a?"does not contain an element containing":"contains an element containing":a?"does not contain":"contains"} ${s}`}}async range(e,t,a,n){return`${e} ${n?"is not":"is"} between ${t} and ${a}`}},q=t.M=u=class{constructor(){u.prototype.__init3.call(this)}__init3(){this.NOT_FOUND_QUERY="(1 = 0)"}operator(e){switch(e){case"NOT":case"AND NOT":return"AND NOT";case"OR NOT":return"OR NOT";case"&&":case"<implicit>":case"AND":return"AND";case"||":case"OR":return"OR";default:throw Error(`Unexpected operator. ${e}`)}}async eq(e,t,a,n){let{column:r,columnJSON:i,found:s,propertyType:l,isArray:u,mapKeyIndexExpression:c,arrayMapKeyExpression:m}=await this.getColumnForField(e,n);if(!s)return this.NOT_FOUND_QUERY;if(r&&u)return D({column:r,mapKey:m,term:t,propertyType:l,isNegatedField:a,exactMatch:!0});let d=c&&!a?` AND ${c}`:"";if("bool"===l){let e=`${t}`.trim().toLowerCase();return A.default.format(`(?? ${a?"!":""}= ?${d})`,[r,"true"===e?1:"false"===e?0:parseInt(e)])}return"number"===l?A.default.format(`(${r} ${a?"!":""}= CAST(?, 'Float64')${d})`,[t]):"json"===l?A.default.format(`(${o([i,"optionalAccess",e=>e.string])} ${a?"!":""}= ?${d})`,[t]):A.default.format(`(${r} ${a?"!":""}= ?${d})`,[t])}async isNotNull(e,t,a){let{column:n,columnJSON:r,found:i,propertyType:s,mapKeyIndexExpression:l,isArray:u,arrayMapKeyExpression:c}=await this.getColumnForField(e,a);if(!i)return this.NOT_FOUND_QUERY;let m=l&&!t?` AND ${l}`:"";if(n&&u&&("map"===s||"json"===s)&&c){let e="map"===s?A.default.format("el[?]",[c]):A.default.format("el.??",[c]);return A.default.format(`${t?"NOT ":""}arrayExists(el -> notEmpty(toString(${e})) = 1, ?)`,[A.default.raw(n)])}return"json"!==s||u?`notEmpty(${n}) ${t?"!":""}= 1${m}`:`notEmpty(${o([r,"optionalAccess",e=>e.string])}) ${t?"!":""}= 1${m}`}async gte(e,t,a){let{column:n,columnJSON:r,found:i,propertyType:s,isArray:l,mapKeyIndexExpression:u}=await this.getColumnForField(e,a);if(!i)return this.NOT_FOUND_QUERY;if(l)throw Error(">= comparison is not supported for Array-type fields");let c=u?` AND ${u}`:"";return"json"===s?A.default.format(`(${o([r,"optionalAccess",e=>e.number])} >= ?${c})`,[t]):A.default.format(`(${n} >= ?${c})`,[t])}async lte(e,t,a){let{column:n,columnJSON:r,found:i,propertyType:s,isArray:l,mapKeyIndexExpression:u}=await this.getColumnForField(e,a);if(!i)return this.NOT_FOUND_QUERY;if(l)throw Error("<= comparison is not supported for Array-type fields");let c=u?` AND ${u}`:"";return"json"===s?A.default.format(`(${o([r,"optionalAccess",e=>e.number])} <= ?${c})`,[t]):A.default.format(`(${n} <= ?${c})`,[t])}async lt(e,t,a){let{column:n,columnJSON:r,found:i,propertyType:s,isArray:l,mapKeyIndexExpression:u}=await this.getColumnForField(e,a);if(!i)return this.NOT_FOUND_QUERY;if(l)throw Error("< comparison is not supported for Array-type fields");let c=u?` AND ${u}`:"";return"json"===s?A.default.format(`(${o([r,"optionalAccess",e=>e.number])} < ?${c})`,[t]):A.default.format(`(${n} < ?${c})`,[t])}async gt(e,t,a){let{column:n,columnJSON:r,found:i,propertyType:s,isArray:l,mapKeyIndexExpression:u}=await this.getColumnForField(e,a);if(!i)return this.NOT_FOUND_QUERY;if(l)throw Error("> comparison is not supported for Array-type fields");let c=u?` AND ${u}`:"";return"json"===s?A.default.format(`(${o([r,"optionalAccess",e=>e.number])} > ?${c})`,[t]):A.default.format(`(${n} > ?${c})`,[t])}attemptToParseNumber(e){let t=Number.parseFloat(e);return Number.isNaN(t)?e:t}tokenizeTerm(e){return e.split(/[ -/:-@[-`{-~\t\n\r]+/).filter(e=>e.length>0)}termHasSeparators(e){return null!=e.match(/[ -/:-@[-`{-~\t\n\r]+/)}async range(e,t,a,n,r){let{column:i,found:s,mapKeyIndexExpression:o,isArray:l}=await this.getColumnForField(e,r);if(!s)return this.NOT_FOUND_QUERY;if(l)throw Error("range comparison is not supported for Array-type fields");let u=o&&!n?` AND ${o}`:"";return A.default.format(`(${i} ${n?"NOT ":""}BETWEEN ? AND ?${u})`,[this.attemptToParseNumber(t),this.attemptToParseNumber(a)])}};function D({column:e,mapKey:t,term:a,isNegatedField:n,propertyType:r,exactMatch:i}){let s=n?"NOT ":"";if("number"===r)return A.default.format(`${s}has(?, CAST(?, 'Float64'))`,[A.default.raw(e),a]);if("bool"===r){let t=`${a}`.trim().toLowerCase(),n="true"===t?1:"false"===t?0:a;return A.default.format(`${s}has(?, ?)`,[A.default.raw(e),n])}if("map"===r){if(!t)throw Error(`Map key expression is required for searching column ${e}. Try '${e}.key:value'`);return i?A.default.format(`${s}arrayExists(el -> el[?] = ?, ?)`,[t,a,A.default.raw(e)]):A.default.format(`${s}arrayExists(el -> el[?] ILIKE ?, ?)`,[t,`%${a}%`,A.default.raw(e)])}if("json"===r){if(!t)throw Error(`Map key expression is required for searching column ${e}. Try '${e}.key:value'`);return i?A.default.format(`${s}arrayExists(el -> toString(el.??) = ?, ?)`,[t,a,A.default.raw(e)]):A.default.format(`${s}arrayExists(el -> toString(el.??) ILIKE ?, ?)`,[t,`%${a}%`,A.default.raw(e)])}let o="string"===r?"el":A.default.format("toString(el)",[A.default.raw(e)]);return i&&"string"===r?A.default.format(`${s}has(?, ?)`,[A.default.raw(e),a]):i?A.default.format(`${s}arrayExists(el -> ${o} = ?, ?)`,[a,A.default.raw(e)]):A.default.format(`${s}arrayExists(el -> ${o} ILIKE ?, ?)`,[`%${a}%`,A.default.raw(e)])}var U=class extends q{constructor({metadata:e,databaseName:t,tableName:a,connectionId:n,implicitColumnExpression:r}){super(),this.metadata=e,this.databaseName=t,this.tableName=a,this.implicitColumnExpression=r,this.connectionId=n,this.skipIndicesPromise=this.metadata.getSkipIndices({databaseName:t,tableName:a,connectionId:n}).catch(e=>(console.error("Error fetching skip indices:",e),[])),this.enableTextIndexPromise=this.metadata.getSetting({settingName:"enable_full_text_index",connectionId:n}).then(e=>"1"===e).catch(e=>(console.error("Error fetching enable_full_text_index setting:",e),!1))}async fieldSearch(e,t,a,n,r,i){let s=e===$,{column:l,columnJSON:u,found:c,propertyType:m,isArray:p,mapKeyIndexExpression:g,arrayMapKeyExpression:h}=await this.getColumnForField(e,i);if(!c)return this.NOT_FOUND_QUERY;let f=!g||a||s&&i.isNegatedAndParenthesized?"":` AND ${g}`;if(p)return D({column:l,mapKey:h,term:t,propertyType:m,isNegatedField:a,exactMatch:!1});if("bool"===m){let e=`${t}`.trim().toLowerCase();return A.default.format(`(?? ${a?"!":""}= ?${f})`,[l,"true"===e?1:"false"===e?0:parseInt(e)])}if("number"===m)return A.default.format(`(?? ${a?"!":""}= CAST(?, 'Float64')${f})`,[l,t]);if("json"===m)return A.default.format(`(${o([u,"optionalAccess",e=>e.string])} ${a?"NOT ":""}ILIKE ?${f})`,[`%${t}%`]);if(0===t.length)return"(1=1)";if(s){let e=!i.implicitColumnExpression;if(n||r)return A.default.format(`(lower(?) ${a?"NOT ":""}LIKE lower(?))`,[A.default.raw(l),`${n?"%":""}${t}${r?"%":""}`]);if(e){let e=await this.enableTextIndexPromise?await this.findTextIndex(l):void 0;if(e&&"splitByNonAlpha"===o([d.F.call(void 0,e),"optionalAccess",e=>e.type])){let e=this.tokenizeTerm(t),n=this.termHasSeparators(t),r=T.chunk.call(void 0,e,50),i=r.map(e=>A.default.format("hasAllTokens(?, ?)",[A.default.raw(l),e.join(" ")]));return n||r.length>1?`(${a?"NOT (":""}${[...i,A.default.format("(lower(?) LIKE lower(?))",[A.default.raw(l),`%${t}%`])].join(" AND ")}${a?")":""})`:`(${a?"NOT ":""}${i.join(" AND ")})`}let n=this.termHasSeparators(t),r=await this.findBloomFilterTokensIndex(l);if(r.found){let e=/\blower\s*\(/.test(r.indexExpression)?A.default.format("tokens(lower(?))",[t]):A.default.format("tokens(?)",[t]);return n?`(${a?"NOT (":""}${[`hasAll(${r.indexExpression}, ${e})`,A.default.format("(lower(?) LIKE lower(?))",[A.default.raw(l),`%${t}%`])].join(" AND ")}${a?")":""})`:`(${a?"NOT ":""}hasAll(${r.indexExpression}, ${e}))`}if(!n)return A.default.format(`(${a?"NOT ":""}hasToken(lower(?), lower(?)))`,[A.default.raw(l),t]);{let e=this.tokenizeTerm(t);return`(${a?"NOT (":""}${[...e.map(e=>A.default.format("hasToken(lower(?), lower(?))",[A.default.raw(l),e])),A.default.format("(lower(?) LIKE lower(?))",[A.default.raw(l),`%${t}%`])].join(" AND ")}${a?")":""})`}}}return A.default.format(`(${l} ${a?"NOT ":""}? ?${f})`,[A.default.raw("ILIKE"),`%${t}%`])}async buildColumnExpressionFromField(e){let t=await this.metadata.getColumn({databaseName:this.databaseName,tableName:this.tableName,column:e,connectionId:this.connectionId});if(t){let a={found:!0,columnType:t.type,columnExpression:t.name},n;try{n=await this.metadata.getMaterializedColumnsLookupTable({databaseName:this.databaseName,tableName:this.tableName,connectionId:this.connectionId})}catch(e){console.debug("Error in getMaterializedColumnsLookupTable",e),n=new Map}let r=(()=>{for(let[t,a]of n.entries())if(a===e)return{materializedTarget:t,materializedName:a}})();if(r){let e=I(r.materializedTarget);e&&(a.mapKeyIndexExpression=`indexHint(${e})`)}return a}let a=await L({field:e,metadata:this.metadata,databaseName:this.databaseName,tableName:this.tableName,connectionId:this.connectionId});if(a){let t=a.name.split("."),n=e.split(".").slice(t.length).join(".");if(a.type.startsWith("Map")){let e=o([a,"access",e=>e.type,"access",e=>e.match,"call",e=>e(/,\s+(\w+)\)$/),"optionalAccess",e=>e[1]]);return{found:!0,columnExpression:A.default.format("??[?]",[a.name,n]),mapKeyIndexExpression:`indexHint(${I(`${a.name}['${n}']`)})`,columnType:s(e,()=>"Unknown")}}if(a.type.startsWith("JSON"))return{found:!0,columnExpression:"",columnExpressionJSON:{string:A.default.format("toString(??)",[e]),number:A.default.format("dynamicType(??) in (?) and ??",[e,v,e])},columnType:"JSON"};if("String"===a.type){let e=n.split(".");return{found:!0,columnExpression:A.default.format(`JSONExtractString(??, ${Array(e.length).fill("?").join(",")})`,[a.name,...e]),columnType:"String"}}if(a.type.startsWith("Array"))return{found:!0,columnType:a.type,columnExpression:a.name,arrayMapKeyExpression:n};throw Error("Unsupported column type for prefix match")}return{found:!0,columnExpression:e,columnType:"Unknown"}}async findTextIndex(e){let t=await this.skipIndicesPromise;if(!(!t||0===t.length))return t.find(t=>"text"===t.type&&this.indexCoversColumn(t.expression,e))}async findBloomFilterTokensIndex(e){try{let t=await this.skipIndicesPromise;if(!t||0===t.length)return{found:!1};for(let a of t.filter(e=>"bloom_filter"===e.type)){let t=_.parseTokensExpression(a.expression);if(t.hasTokens&&this.indexCoversColumn(t.innerExpression,e))return{found:!0,indexExpression:a.expression}}return{found:!1}}catch(e){return console.warn("Failed to fetch skip indices:",e),{found:!1}}}indexCoversColumn(e,t){let a=e=>e.replace(/\s+/g,"").replace(/`/g,""),n=a(e),r=a(t);if(n===r)return!0;let i=n.match(/\w+/g),s=o([r,"access",e=>e.match,"call",e=>e(/\w+/),"optionalAccess",e=>e[0]]);return!!(s&&i&&i.includes(s))}async getColumnForField(e,t){let a=s(t.implicitColumnExpression,()=>this.implicitColumnExpression);if(e===$&&!a)throw Error("Can not search bare text without an implicit column set.");let n=e===$?a:e;if(e===$&&a===this.implicitColumnExpression){let e=d.e.call(void 0,n);return{column:e.length>1?`concatWithSeparator(';',${e.join(",")})`:n,columnJSON:void 0,propertyType:"string",found:!0}}let r=await this.buildColumnExpressionFromField(n),{type:i,isArray:l}=eA(r.columnType);return{column:r.columnExpression,columnJSON:o([r,"optionalAccess",e=>e.columnExpressionJSON]),propertyType:s(i,()=>void 0),isArray:l,found:r.found,mapKeyIndexExpression:r.mapKeyIndexExpression,arrayMapKeyExpression:l?r.arrayMapKeyExpression:void 0}}};async function M(e,t,a){let n="-"===e.field[0]?e.field.slice(1):e.field,r="-"===e.field[0],i=e.field===$;if(x(e)){let s=C(e.term);if(i&&"-"===e.prefix&&(r=!0),i||"-"!==e.prefix||(s=e.prefix+C(e.term)),e.quoted&&!i)return t.eq(n,s,r,a);if(!e.quoted&&"*"===s)return t.isNotNull(n,r,a);if(!e.quoted&&">="===s.substring(0,2))return r?t.lt(n,s.slice(2),a):t.gte(n,s.slice(2),a);if(!e.quoted&&"<="===s.substring(0,2))return r?t.gt(n,s.slice(2),a):t.lte(n,s.slice(2),a);if(!e.quoted&&">"===s[0])return r?t.lte(n,s.slice(1),a):t.gt(n,s.slice(1),a);if(!e.quoted&&"<"===s[0])return r?t.gte(n,s.slice(1),a):t.lt(n,s.slice(1),a);let o=!1,l=!1;return e.quoted||"*"!==s[0]||(o=!0,s=s.slice(1)),e.quoted||"*"!==s[s.length-1]||(l=!0,s=s.slice(0,-1)),t.fieldSearch(n,s,r,o,l,a)}if(O(e))return t.range(n,e.term_min,e.term_max,r,a);throw Error(`Unexpected Node type. ${e}`)}function k(e,t){if(!t.field||!t.parenthesized||t.field===$)return e;{let a=o([t,"access",e=>e.field,"optionalAccess",e=>e.startsWith,"call",e=>e("-")])?t.field.slice(1):t.field;return{...e,implicitColumnExpression:a,...P(t)?{isNegatedAndParenthesized:!0}:{}}}}function P(e){return e.parenthesized&&o([e,"access",e=>e.field,"optionalAccess",e=>e.startsWith,"call",e=>e("-")])}async function V(e,t,a){if(x(e)||O(e))return await M(e,t,a);if("right"in e&&null!=e.right){let n=t.operator(e.operator,a),r=e.parenthesized,i=k(a,e);return`${P(e)?"NOT ":""}${r?"(":""}${"start"in e&&e.start?`${e.start} `:""}${await V(e.left,t,i)} ${n} ${await V(e.right,t,i)}${r?")":""}`}if("left"in e&&null!=e.left&&!("right"in e&&null!=e.right)){let n=e.parenthesized,r=k(a,e);return`${P(e)?"NOT ":""}${n?"(":""}${null!=e.start?`${e.start} `:""}${await V(e.left,t,r)}${n?")":""}`}return""}async function H(e,t){return await V(e,t,{})}var W=class{constructor(e,t){this.conditions=[],this.searchQ=e,this.serializer=t}setSerializer(e){return this.serializer=e,this}getSerializer(){return this.serializer}async genSearchQuery(){if(!this.searchQ)return"";let e=w(this.searchQ);return await H(e,this.serializer)}and(e){return e&&e.trim()&&this.conditions.push(`(${e})`),this}async build(){let e=await this.genSearchQuery();return this.searchQ&&this.and(e),this.conditions.join(" AND ")}};async function B({query:e,metadata:t,tableConnection:a}){try{let{tableName:n,databaseName:r,connectionId:i}=a,s=w(e);if(s){let e=new F({metadata:t,tableName:n,databaseName:r,connectionId:i});return await V(s,e,{})}}catch(t){console.warn("Parse failure",e,t)}return`Message containing ${e}`}function j(e,t){return t||A.default.format("MetricName = ?",[e])}var K=t.b="__hdx_time_bucket";function G(e){return null!=e.groupBy&&e.groupBy.length>0}function Q(e){return null!=e.timestampValueExpression&&null!=e.granularity}var z=e=>null!=e.metricTables,Y=t.f=e=>Array.isArray(e.select)&&z(e)?{...e,select:e.select.map(e=>({...e,alias:e.alias||(e.isDelta?`${e.aggFn}(delta(${e.metricName}))`:`${e.aggFn}(${e.metricName})`)}))}:e,J=t.g=e=>{if(z(e)&&Array.isArray(e.select)){let t=[];for(let a of e.select)t.push({...e,select:[a]});return t}return[e]},X={"=":"!=",">":"<=","<":">=","!=":"=","<=":">",">=":"<"};function Z(e){return null!=e&&""!=e.trim()}var ee=({materializedFields:e,rawSQL:t})=>{try{let[a]=d.C.call(void 0,t),n=new f.Parser,r=n.astify(a,{database:"Postgresql"}),i=t=>{let a;if(null!=t){switch(t.type){case"column_ref":"string"!=typeof t.column&&(a=`${o([t,"access",e=>e.column,"optionalAccess",e=>e.expr,"access",e=>e.value])}['${o([t,"access",e=>e.array_index,"optionalAccess",e=>e[0],"optionalAccess",e=>e.index,"access",e=>e.value])}']`);break;case"binary_expr":if(Array.isArray(t.left))for(let e of t.left)i(e);else i(t.left);if(Array.isArray(t.right))for(let e of t.right)i(e);else i(t.right);break;case"function":if("expr_list"===o([t,"access",e=>e.args,"optionalAccess",e=>e.type]))if(Array.isArray(o([t,"access",e=>e.args,"optionalAccess",e=>e.value]))){for(let e of t.args.value)i(e);"column_ref"===o([t,"access",e=>e.args,"optionalAccess",e=>e.value,"optionalAccess",e=>e[0],"optionalAccess",e=>e.type])&&"single_quote_string"===o([t,"access",e=>e.args,"optionalAccess",e=>e.value,"optionalAccess",e=>e[1],"optionalAccess",e=>e.type])&&(a=`${o([t,"access",e=>e.name,"optionalAccess",e=>e.name,"optionalAccess",e=>e[0],"optionalAccess",e=>e.value])}(${o([t,"access",e=>e.args,"optionalAccess",e=>e.value,"optionalAccess",e=>e[0],"optionalAccess",e=>e.column,"access",e=>e.expr,"access",e=>e.value])}, '${o([t,"access",e=>e.args,"optionalAccess",e=>e.value,"optionalAccess",e=>e[1],"optionalAccess",e=>e.value])}')`)}else E.default.call(void 0,o([t,"access",e=>e.args,"optionalAccess",e=>e.value]))&&i(t.args.value)}if(a){let n=e.get(a);if(n){for(let e in t)t.hasOwnProperty(e)&&delete t[e];t.type="column_ref",t.table=null,t.column={expr:{type:"default",value:n}}}}}};if(Array.isArray(r.columns))for(let e of r.columns)i(e.expr);return i(r.where),n.sqlify(r)}catch(e){return t}},et=({fn:e,expr:t,level:a,where:n})=>{let r="any"===e,i="none"===e,o=e.startsWith("count"),l=Z(n),u={UNSAFE_RAW_SQL:r||i?`${t}`:`toFloat64OrDefault(toString(${t}))`},c=`${n} AND ${u.UNSAFE_RAW_SQL} IS NOT NULL`;if(e.endsWith("Merge")){let n=eT`${{UNSAFE_RAW_SQL:s(t,()=>"")}}`,r=a&&(e.startsWith("quantile")||e.startsWith("histogram"))?eT`(${{UNSAFE_RAW_SQL:Number.isFinite(a)?`${a}`:"0"}})`:[];return l?eT`${e}If${r}(${n}, ${{UNSAFE_RAW_SQL:c}})`:eT`${e}${r}(${n})`}if(e.endsWith("State"))return null==t||o?l?eT`${e}(${{UNSAFE_RAW_SQL:n}})`:eT`${e}()`:eT`${e}(${u}${l?eT`, ${{UNSAFE_RAW_SQL:c}}`:""})`;if("count"===e)return l?eT`${e}If(${{UNSAFE_RAW_SQL:n}})`:{sql:`${e}()`,params:{}};if("none"===e)return eT`${{UNSAFE_RAW_SQL:s(t,()=>"")}}`;if(null!=t)return"count_distinct"===e?eT`count${l?"If":""}(DISTINCT ${{UNSAFE_RAW_SQL:t}}${l?eT`, ${{UNSAFE_RAW_SQL:n}}`:""})`:null!=a?eT`${e}${l?"If":""}(${{UNSAFE_RAW_SQL:Number.isFinite(a)?`${a}`:"0"}})(${u}${l?eT`, ${{UNSAFE_RAW_SQL:c}}`:""})`:eT`${{UNSAFE_RAW_SQL:e}}${l?"If":""}(
      ${u}${l?eT`, ${{UNSAFE_RAW_SQL:c}}`:""}
    )`;throw Error("Column is required for all non-count aggregation functions")};async function ea(e,t,a){let n;if("string"==typeof e)return eT`${{UNSAFE_RAW_SQL:e}}`;try{n=o([t,"access",e=>e.with,"optionalAccess",e=>e.length])||!t.from.databaseName?void 0:await a.getMaterializedColumnsLookupTable({connectionId:t.connection,databaseName:t.from.databaseName,tableName:t.from.tableName})}catch(e){}let r="ratio"===t.seriesReturnType&&2===e.length,i=await Promise.all(e.map(async e=>{let r=await eo({condition:s(e.aggCondition,()=>""),from:t.from,language:s(e.aggConditionLanguage,()=>"lucene"),implicitColumnExpression:t.implicitColumnExpression,metadata:a,connectionId:t.connection,with:t.with}),i;i=null==e.aggFn?"lucene"===e.valueExpressionLanguage?await eo({condition:e.valueExpression,from:t.from,language:"lucene",implicitColumnExpression:t.implicitColumnExpression,metadata:a,connectionId:t.connection,with:t.with}):eT`${{UNSAFE_RAW_SQL:e.valueExpression}}`:e.aggFn.startsWith("quantile")||e.aggFn.startsWith("histogram")?et({fn:e.aggFn,expr:e.valueExpression,level:e.level,where:r.sql}):et({fn:e.aggFn,expr:e.valueExpression,where:r.sql});let o=`SELECT ${i.sql} FROM \`t\``;return n&&(i.sql=ee({materializedFields:n,rawSQL:o}).replace(/^SELECT\s+/i,"").replace(/\s+FROM `t`$/i,"")),eT`${i}${null!=e.alias&&""!==e.alias.trim()?eT` AS "${{UNSAFE_RAW_SQL:e.alias}}"`:[]}`}));return r?[eT`divide(${i[0]}, ${i[1]})`]:i}function en({interval:e,timestampValueExpression:t,dateRange:a,alias:n=K}){let r={UNSAFE_RAW_SQL:d.f.call(void 0,t)},i={UNSAFE_RAW_SQL:"auto"===e&&Array.isArray(a)?d.l.call(void 0,a):e};return eT`toStartOfInterval(toDateTime(${r}), INTERVAL ${i}) AS \`${{UNSAFE_RAW_SQL:n}}\``}async function er({connectionId:e,databaseName:t,dateRange:a,dateRangeEndInclusive:n,dateRangeStartInclusive:r,includedDataInterval:i,metadata:s,tableName:l,timestampValueExpression:u,with:c}){let m=a[0].getTime(),p=a[1].getTime(),g=u;try{if(t&&l&&e){let{primary_key:a}=await s.getTableMetadata({databaseName:t,tableName:l,connectionId:e});g=d.z.call(void 0,u,a)}}catch(e){console.warn("Failed to optimize timestampValueExpression",e)}let h=d.e.call(void 0,g);return eS("AND",...await Promise.all(h.map(async a=>{let u=a.trim(),g=d.y.call(void 0,u),h=o([c,"optionalAccess",e=>e.length])||g?null:await s.getColumn({databaseName:t,tableName:l,column:u,connectionId:e}),f={UNSAFE_RAW_SQL:u};null!=h||o([c,"optionalAccess",e=>e.length])||g||console.warn(`Column ${u} not found in ${t}.${l} while inferring type for time filter`);let y=i?eT`toStartOfInterval(fromUnixTimestamp64Milli(${{Int64:m}}), INTERVAL ${i}) - INTERVAL ${i}`:g?eT`${g.function}(fromUnixTimestamp64Milli(${{Int64:m}})${g.formattedRemainingArgs})`:eT`fromUnixTimestamp64Milli(${{Int64:m}})`,E=i?eT`toStartOfInterval(fromUnixTimestamp64Milli(${{Int64:p}}), INTERVAL ${i}) + INTERVAL ${i}`:g?eT`${g.function}(fromUnixTimestamp64Milli(${{Int64:p}})${g.formattedRemainingArgs})`:eT`fromUnixTimestamp64Milli(${{Int64:p}})`;return"Date"===o([h,"optionalAccess",e=>e.type])?eT`(${f} ${r?">=":">"} toDate(${y}) AND ${f} ${n?"<=":"<"} toDate(${E}))`:eT`(${f} ${r?">=":">"} ${y} AND ${f} ${n?"<=":"<"} ${E})`})))}async function ei(e,t){let a=Q(e),n=G(e);return eS(",",await ea(e.select,e,t),n&&!1!==e.selectGroupBy?await ea(e.groupBy,e,t):[],a?en({interval:e.granularity,timestampValueExpression:e.timestampValueExpression,dateRange:e.dateRange}):[])}function es({from:e}){return eS(".",eT`${""===e.databaseName?"":{Identifier:e.databaseName}}`,eT`${{Identifier:e.tableName}}`)}async function eo({condition:e,language:t,metadata:a,from:n,implicitColumnExpression:r,connectionId:i,with:s}){let l,u=e;if("lucene"===t){let t=new U({metadata:a,databaseName:n.databaseName,tableName:n.tableName,implicitColumnExpression:r,connectionId:i});u=await new W(e,t).build()}try{l=o([s,"optionalAccess",e=>e.length])||!n.databaseName?void 0:await a.getMaterializedColumnsLookupTable({connectionId:i,databaseName:n.databaseName,tableName:n.tableName})}catch(e){}let c="SELECT * FROM `t` WHERE ",m=`${c}${u}`;return l&&(u=ee({materializedFields:l,rawSQL:m}).replace(c,"")),eT`${{UNSAFE_RAW_SQL:u}}`}async function el(e,t){let a=[];Z(e.where)&&(a=e_(await eo({condition:e.where,from:e.from,language:s(e.whereLanguage,()=>"sql"),implicitColumnExpression:e.implicitColumnExpression,metadata:t,connectionId:e.connection,with:e.with}),"(",")"));let n=[];"string"!=typeof e.select&&e.select.every(e=>Z(e.aggCondition))&&(n=(await Promise.all(e.select.map(async a=>Z(a.aggCondition)?await eo({condition:a.aggCondition,from:e.from,language:s(a.aggConditionLanguage,()=>"sql"),implicitColumnExpression:e.implicitColumnExpression,metadata:t,connectionId:e.connection,with:e.with}):null))).filter(e=>null!==e));let r=await Promise.all(s(e.filters,()=>[]).map(async a=>{if("sql_ast"===a.type)return e_(eT`${{UNSAFE_RAW_SQL:a.left}} ${a.operator} ${{UNSAFE_RAW_SQL:a.right}}`,"(",")");if("lucene"===a.type||"sql"===a.type)return e_(await eo({condition:a.condition,from:e.from,language:a.type,implicitColumnExpression:e.implicitColumnExpression,metadata:t,connectionId:e.connection,with:e.with}),"(",")");throw Error(`Unknown filter type: ${a.type}`)}));return eS(" AND ",null!=e.dateRange&&null!=e.timestampValueExpression?await er({timestampValueExpression:e.timestampValueExpression,dateRange:e.dateRange,dateRangeStartInclusive:s(e.dateRangeStartInclusive,()=>!0),dateRangeEndInclusive:s(e.dateRangeEndInclusive,()=>!0),metadata:t,connectionId:e.connection,databaseName:e.from.databaseName,tableName:e.from.tableName,with:e.with,includedDataInterval:e.includedDataInterval}):[],a,e_(eS(" OR ",n),"(",")"),e_(eS("OR"===e.filtersLogicalOperator?" OR ":" AND ",...r),"(",")"))}async function eu(e,t){return eS(",",G(e)?await ea(e.groupBy,e,t):[],Q(e)?en({interval:e.granularity,timestampValueExpression:e.timestampValueExpression,dateRange:e.dateRange}):[])}async function ec(e,t){if(Z(e.having))return await eo({condition:e.having,from:e.from,language:s(e.havingLanguage,()=>"sql"),implicitColumnExpression:e.implicitColumnExpression,metadata:t,connectionId:e.connection,with:e.with})}async function em(e,t,a){let{with:n}=e;if(n)return eS(",",await Promise.all(n.map(async e=>{let{sql:n,chartConfig:r}=e;if(n&&r)throw Error("cannot specify both 'sql' and 'chartConfig' in with clause");if(!(n||r))throw Error("must specify either 'sql' or 'chartConfig' in with clause");if(n&&!p.p.safeParse(n).success)throw Error("non-conforming sql object in CTE");if(r&&!p.J.safeParse(r).success)throw Error(`non-conforming chartConfig object in CTE: ${p.J.safeParse(r).error}`);let i=n||await ep(r,t,a);return!1===e.isSubquery?eT`(${i}) AS ${{Identifier:e.name}}`:eT`${e.name} AS (${i})`})))}async function ed(e,t){let a=e.metricTables;if(!a)return e;let{select:n,from:r,filters:i,where:o,...l}=e;if(!n||!Array.isArray(n))throw Error("multi select or string select on metrics not supported");let{metricType:u,metricName:c,metricNameSql:m,...p}=n[0];if("gauge"===u&&c){var g;let n,o,u,h,f="__hdx_time_bucket2",y=en({interval:e.granularity||"auto",timestampValueExpression:e.timestampValueExpression||"TimeUnix",dateRange:e.dateRange,alias:f}),E=await el({...e,from:{...r,tableName:a.gauge},filters:[...s(i,()=>[]),{type:"sql",condition:j(c,m)}]},t),A=p.isDelta?(g="Value",n="auto"===e.granularity&&Array.isArray(e.dateRange)?d.l.call(void 0,e.dateRange):e.granularity,o=d.m.call(void 0,s(n,()=>"")),u=`(argMax(${g}, ${e.timestampValueExpression}) - argMin(${g}, ${e.timestampValueExpression}))`,h=`date_diff('second', min(toDateTime(${e.timestampValueExpression})), max(toDateTime(${e.timestampValueExpression})))`,`IF(${h} > 0, ${u} * ${o} / ${h}, 0)`):"last_value(Value)";return{...l,with:[{name:"Source",sql:eT`
            SELECT
              *,
              cityHash64(mapConcat(ScopeAttributes, ResourceAttributes, Attributes)) AS AttributesHash
            FROM ${es({from:{...r,tableName:a.gauge}})}
            WHERE ${E}
          `},{name:"Bucketed",sql:eT`
            SELECT
              ${y},
              AttributesHash,
              ${A} AS LastValue,
              any(ScopeAttributes) AS ScopeAttributes,
              any(ResourceAttributes) AS ResourceAttributes,
              any(Attributes) AS Attributes,
              any(ResourceSchemaUrl) AS ResourceSchemaUrl,
              any(ScopeName) AS ScopeName,
              any(ScopeVersion) AS ScopeVersion,
              any(ScopeDroppedAttrCount) AS ScopeDroppedAttrCount,
              any(ScopeSchemaUrl) AS ScopeSchemaUrl,
              any(ServiceName) AS ServiceName,
              any(MetricDescription) AS MetricDescription,
              any(MetricUnit) AS MetricUnit,
              any(StartTimeUnix) AS StartTimeUnix,
              any(Flags) AS Flags
            FROM Source
            GROUP BY AttributesHash, ${f}
            ORDER BY AttributesHash, ${f}
          `}],select:[{...p,valueExpression:"LastValue",aggCondition:""}],from:{databaseName:"",tableName:"Bucketed"},where:"",timestampValueExpression:f,settings:eT`short_circuit_function_evaluation = 'force_enable'`}}if("sum"===u&&c){let n="__hdx_time_bucket2",o="`__hdx_value_high`",u="`__hdx_value_high_prev`",g=en({interval:e.granularity||"auto",timestampValueExpression:e.timestampValueExpression||"TimeUnix",dateRange:e.dateRange,alias:n}),h=await el({...e,from:{...r,tableName:a.sum},filters:[...s(i,()=>[]),{type:"sql",condition:j(c,m)}],includedDataInterval:"auto"===e.granularity&&Array.isArray(e.dateRange)?d.l.call(void 0,e.dateRange):e.granularity},t);return{...l,with:[{name:"Source",sql:eT`
                SELECT
                  *,
                  cityHash64(mapConcat(ScopeAttributes, ResourceAttributes, Attributes)) AS AttributesHash,
                  IF(AggregationTemporality = 1,
                    SUM(Value) OVER (PARTITION BY AttributesHash ORDER BY AttributesHash, TimeUnix ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),
                    IF(IsMonotonic = 0, 
                      Value,
                      deltaSum(Value) OVER (PARTITION BY AttributesHash ORDER BY AttributesHash, TimeUnix ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)
                    )
                  ) AS Rate,
                  IF(AggregationTemporality = 1, Rate, Value) AS Sum
                FROM ${es({from:{...r,tableName:a.sum}})}
                WHERE ${h}`},{name:"Bucketed",sql:eT`
            SELECT
              ${g},
              AttributesHash,
              last_value(Source.Rate) AS ${o},
              any(${o}) OVER(PARTITION BY AttributesHash ORDER BY \`${n}\` ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS ${u},
              IF(IsMonotonic = 1, ${o} - ${u}, ${o}) AS Rate,
              last_value(Source.Sum) AS Sum,
              any(ResourceAttributes) AS ResourceAttributes,
              any(ResourceSchemaUrl) AS ResourceSchemaUrl,
              any(ScopeName) AS ScopeName,
              any(ScopeVersion) AS ScopeVersion,
              any(ScopeAttributes) AS ScopeAttributes,
              any(ScopeDroppedAttrCount) AS ScopeDroppedAttrCount,
              any(ScopeSchemaUrl) AS ScopeSchemaUrl,
              any(ServiceName) AS ServiceName,
              any(MetricName) AS MetricName,
              any(MetricDescription) AS MetricDescription,
              any(MetricUnit) AS MetricUnit,
              any(Attributes) AS Attributes,
              any(StartTimeUnix) AS StartTimeUnix,
              any(Flags) AS Flags,
              any(AggregationTemporality) AS AggregationTemporality,
              any(IsMonotonic) AS IsMonotonic
            FROM Source
            GROUP BY AttributesHash, \`${n}\`
            ORDER BY AttributesHash, \`${n}\`
          `}],select:[p.aggFn?{alias:"Value",...p,valueExpression:"Rate",aggCondition:""}:{alias:"Value",...p,valueExpression:"last_value(Sum)",aggCondition:""}],from:{databaseName:"",tableName:"Bucketed"},where:"",timestampValueExpression:`\`${n}\``}}if("histogram"===u&&c){let{alias:n}=p,o=n||"Value",u={...e,from:{...r,tableName:a.histogram},filters:[...s(i,()=>[]),{type:"sql",condition:j(c,m)}],includedDataInterval:"auto"===e.granularity&&Array.isArray(e.dateRange)?d.l.call(void 0,e.dateRange):e.granularity},g=Q(u)?en({interval:u.granularity,timestampValueExpression:u.timestampValueExpression,dateRange:u.dateRange}):eT``,h=await el(u,t),f;return G(e)&&(f=eS(",",await ea(e.groupBy,e,t))),{...l,with:eq({select:p,timeBucketSelect:g.sql?eT`${g}`:"TimeUnix AS `__hdx_time_bucket`",groupBy:f,from:es({from:{...r,tableName:a.histogram}}),where:h,valueAlias:o}),select:`\`__hdx_time_bucket\`${f?", group":""}, "${o}"`,from:{databaseName:"",tableName:"metrics"},where:"",groupBy:void 0,granularity:void 0,timestampValueExpression:"`__hdx_time_bucket`",settings:eT`short_circuit_function_evaluation = 'force_enable'`}}throw Error(`no query support for metric type=${u}`)}async function ep(e,t,a){let n,r=z(e)?await ed(e,t):e,i=await em(r,t,a),l=await ei(r,t),u=es(r),c=await el(r,t),m=await eu(r,t),p=await ec(r,t),g=function(e){let t=Q(e);if(!(null==e.orderBy&&!t)){var a;return eS(",",t?en({interval:e.granularity,timestampValueExpression:e.timestampValueExpression,dateRange:e.dateRange}):[],null!=e.orderBy?"string"==typeof(a=e.orderBy)?eT`${{UNSAFE_RAW_SQL:a}}`:a.map(e=>eT`${{UNSAFE_RAW_SQL:e.valueExpression}} ${"DESC"===e.ordering?"DESC":"ASC"}`):[])}}(r),h=function(e){if(null==e.limit||null==e.limit.limit)return;let t=null!=e.limit.offset?eT` OFFSET ${{Int32:e.limit.offset}}`:[];return eT`${{Int32:e.limit.limit}}${t}`}(r),f=(n=d.E.call(void 0,a),eS(", ",[eT`${s(r.settings,()=>"")}`,eT`${s(n,()=>"")}`]));return eS(" ",[eT`${o([i,"optionalAccess",e=>e.sql])?eT`WITH ${i}`:""}`,eT`SELECT ${l}`,eT`FROM ${u}`,eT`${c.sql?eT`WHERE ${c}`:""}`,eT`${o([m,"optionalAccess",e=>e.sql])?eT`GROUP BY ${m}`:""}`,eT`${o([p,"optionalAccess",e=>e.sql])?eT`HAVING ${p}`:""}`,eT`${o([g,"optionalAccess",e=>e.sql])?eT`ORDER BY ${g}`:""}`,eT`${o([h,"optionalAccess",e=>e.sql])?eT`LIMIT ${h}`:""}`,eT`${f.sql?eT`SETTINGS ${f}`:[]}`])}var eg=((n=eg||{}).Array="array",n.Date="date",n.Map="map",n.Number="number",n.String="string",n.Tuple="tuple",n.Bool="bool",n.JSON="json",n.Dynamic="dynamic",n),eh=t.m=e=>{let t={};return e.headers.forEach((e,a)=>{t[a]=e}),t},ef=t.n=e=>e.startsWith("Date")?"date":e.startsWith("Tuple")?"tuple":e.startsWith("Map")?"map":e.startsWith("Array")?"array":e.startsWith("Int")||e.startsWith("UInt")||e.startsWith("Float")||e.startsWith("Nullable(Int")||e.startsWith("Nullable(UInt")||e.startsWith("Nullable(Float")?"number":e.startsWith("String")||e.startsWith("Nullable(String)")||e.startsWith("FixedString")||e.startsWith("Enum")||e.startsWith("UUID")||e.startsWith("IPv4")||e.startsWith("IPv6")?"string":"Bool"===e?"bool":e.startsWith("JSON")?"json":e.startsWith("Dynamic")?"dynamic":e.startsWith("LowCardinality")?ef(e.slice(15,-1)):null,ey=t.o=e=>"map"===e||"array"===e||"json"===e||"tuple"===e||"dynamic"===e,eE=t.p=e=>e.trim().startsWith("Array(")&&e.trim().endsWith(")")?ef(e.trim().slice(6,-1)):null,eA=t.q=e=>{let t=ef(e),a="array"===t;if("map"===t||"tuple"===t)throw Error("Map or Tuple types cannot be searched with Lucene.");return"date"===t?t="number":"array"===t&&eE(e)&&(t=eE(e)),{type:t,isArray:a}},eN=e=>`HYPERDX_PARAM_${Math.abs(d.k.call(void 0,`${e}`))}`,eT=t.r=(e,...t)=>({sql:e.map((e,a)=>{let n=t[a];return e+(null==n?"":"string"==typeof n?n:"UNSAFE_RAW_SQL"in n?n.UNSAFE_RAW_SQL:Array.isArray(n)?n.map(e=>e.sql).join(""):"sql"in n?n.sql:"Identifier"in n?`{${eN(n.Identifier)}:Identifier}`:"String"in n?`{${eN(n.String)}:String}`:"Float32"in n?`{${eN(n.Float32)}:Float32}`:"Float64"in n?`{${eN(n.Float64)}:Float64}`:"Int32"in n?`{${eN(n.Int32)}:Int32}`:"Int64"in n?`{${eN(n.Int64)}:Int64}`:"")}).join(""),params:t.reduce((e,t)=>({...e,...null==t||"string"==typeof t||"UNSAFE_RAW_SQL"in t?{}:Array.isArray(t)?t.reduce((e,t)=>(Object.assign(e,t.params),e),{}):"params"in t?t.params:"Identifier"in t?{[eN(t.Identifier)]:t.Identifier}:"String"in t?{[eN(t.String)]:t.String}:"Float32"in t?{[eN(t.Float32)]:t.Float32}:"Float64"in t?{[eN(t.Float64)]:t.Float64}:"Int32"in t?{[eN(t.Int32)]:t.Int32}:"Int64"in t?{[eN(t.Int64)]:t.Int64}:{}}),{})}),eS=t.s=(e,...t)=>t.reduce((t,a)=>{if(Array.isArray(a)){if(0===a.length)return t;t.sql+=(t.sql.length>0?e:"")+a.map(e=>e.sql).filter(Boolean).join(e),t.params=a.reduce((e,t)=>(Object.assign(e,t.params),e),t.params)}else a.sql.length>0&&(t.sql+=`${t.sql.length>0?e:""}${a.sql}`,Object.assign(t.params,a.params));return t},{sql:"",params:{}}),e_=t.t=(e,t,a)=>(Array.isArray(e)?e.every(e=>0===e.sql.length):0===e.sql.length)?[]:eT`${t}${e}${a}`,eR=t.u=class extends Error{constructor(e,t){super(e),this.query=t,this.name="ClickHouseQueryError"}},eb=t.v=e=>{let t=new h.Parser,a=d.e.call(void 0,e);return o([a,"optionalAccess",e=>e.length])?a.flatMap(e=>{try{let a=/\b[a-zA-Z0-9_]+\[([0-9]+|'[^']*')\]/g,n=e.match(a)||[],r=e.replace(a,"''").replace(/\.:[a-zA-Z0-9]+/g,""),i=/\b[a-zA-Z0-9_]+\.[a-zA-Z0-9_.]+/g,s=r.match(i)||[],o=r.replace(i,"''"),l=t.columnList(`select ${o}`).map(e=>e.split("::")[2]);return[...new Set([...l,...s,...n])]}catch(t){return console.error("Error parsing column references from key",t,e),[]}}):[]},eC=e=>"string"==typeof e?""===e.trim()?NaN:Number(e):e,ew=t.w=(e,t)=>{let a=eC(e),n=eC(t);return isNaN(a)||isNaN(n)||0===n?NaN:a/n},eI=t.x=e=>{let t=e.meta,a=e.data,n=eL(s(t,()=>[])),r=o([t,"optionalAccess",e=>e.filter,"call",e=>e(e=>e.name!==o([n,"optionalAccess",e=>e.name]))]),i=o([r,"optionalAccess",e=>e[0]]),l=o([r,"optionalAccess",e=>e[1]]);if(!i||!l)throw Error(`Unable to compute ratio - meta information: ${JSON.stringify(t)}.`);let u=`${i.name}/${l.name}`;return{...e,data:a.map(e=>({[u]:ew(e[i.name],e[l.name]),...n?{[n.name]:e[n.name]}:{}})),meta:[{name:u,type:"Float64"},...n?[{name:n.name,type:n.type}]:[]]}},e$=t.y=c=class{__init4(){this.requestTimeout=36e5}constructor({host:e,username:t,password:a,queryTimeout:n,application:r,requestTimeout:i}){c.prototype.__init4.call(this),this.host=e,this.username=t,this.password=a,this.queryTimeout=n,this.maxRowReadOnly=!1,this.application=r,null!=i&&i>=0&&(this.requestTimeout=i)}getClient(){if(!this.client)throw Error("ClickHouse client not initialized. Child classes must initialize the client.");return this.client}logDebugQuery(e,t={}){let a="";try{a=eO({sql:e,params:t})}catch(t){a=e}console.debug("--------------------------------------------------------"),console.debug("Sending Query:",a),console.debug("--------------------------------------------------------")}processClickhouseSettings(e){let t=structuredClone(e||{});return o([t,"optionalAccess",e=>e.max_rows_to_read])&&this.maxRowReadOnly&&delete t.max_rows_to_read,void 0===o([t,"optionalAccess",e=>e.max_execution_time])&&(this.queryTimeout||0)>0&&(t.max_execution_time=this.queryTimeout),{allow_experimental_analyzer:1,date_time_output_format:"iso",wait_end_of_query:0,cancel_http_readonly_queries_on_client_close:1,...t}}async query(e){let t=0;for(;t<2;){try{return await this.__query(e)}catch(t){if(!this.maxRowReadOnly&&"READONLY"===t.type&&t.message.includes("max_rows_to_read"))this.maxRowReadOnly=!0;else{let a=t;try{let n="";try{n=eO({sql:e.query,params:s(e.query_params,()=>({}))})}catch(t){n=e.query}(a=new eR(t.message,n)).cause=t}catch(e){}throw a}}t++}throw Error("ClickHouseClient query impossible codepath")}async queryChartConfig({config:e,metadata:t,opts:a,querySettings:n}){e=Y(e);let r=await Promise.all(J(e).map(e=>ep(e,t,n))),i="line"===e.displayType,l=await Promise.all(r.map(async t=>(await this.query({query:t.sql,query_params:t.params,format:"JSON",abort_signal:o([a,"optionalAccess",e=>e.abort_signal]),connectionId:e.connection,clickhouse_settings:o([a,"optionalAccess",e=>e.clickhouse_settings])})).json()));if(1===l.length)return l[0];if(l.length>1){let t=new Map,a=new Map;for(let e of l){if(Array.isArray(e.meta))for(let a of e.meta){let e=a.name;t.has(e)||t.set(e,a)}let n=eL(s(e.meta,()=>[])),r=o([eF,"call",t=>t(s(e.meta,()=>[])),"optionalAccess",e=>e[0],"optionalAccess",e=>e.name]);for(let t of e.data){let e=r?Object.fromEntries(Object.entries(t).filter(([e])=>e!==r)):{...t},s=null!=n?t[n.name]:i?y.default.call(void 0,e):"__FIXED_TIMESTAMP__";if(a.has(s)){let e=a.get(s);a.set(s,{...e,...t})}else a.set(s,t)}}let n="ratio"===e.seriesReturnType&&2===l.length,r={meta:Array.from(t.values()),data:Array.from(a.values())};return n?eI(r):r}throw Error("No result sets")}async testChartConfigValidity({config:e,metadata:t,opts:a,querySettings:n}){try{let r=await ep(e,t,n),i=eT`EXPLAIN ESTIMATE ${r}`,s=await (await this.query({query:i.sql,query_params:i.params,format:"JSON",abort_signal:o([a,"optionalAccess",e=>e.abort_signal]),connectionId:e.connection,clickhouse_settings:o([a,"optionalAccess",e=>e.clickhouse_settings])})).json(),l=Number(o([s,"access",e=>e.data,"access",e=>e[0],"optionalAccess",e=>e.rows]));return{isValid:!0,rowEstimate:Number.isNaN(l)?void 0:l}}catch(e){return{isValid:!1,error:e instanceof eR?e.message:"Error while constructing materialized view query"}}}},ex=t.z=({database:e,table:t})=>eT`${{Identifier:e}}.${{Identifier:t}}`;function eO({sql:e,params:t}){return Object.entries(t).reduce((e,[t,a])=>e.replace(RegExp(`{${t}:\\w+}`,"g"),a),e)}function ev(e,t){return e.filter(e=>{let a=ef(e.type);return null!=a&&t.includes(a)})}function eL(e){return o([ev,"call",t=>t(e,["date"]),"optionalAccess",e=>e[0]])}function eF(e){return ev(e,["number"])}var eq=({select:e,...t})=>{if("quantile"===e.aggFn){if(!("level"in e)||null===e.level)throw Error("quantile must have a level");return eU({...t,level:e.level})}if("count"===e.aggFn)return eD(t);throw Error(`${e.aggFn} is not supported for histograms currently`)},eD=({timeBucketSelect:e,groupBy:t,from:a,where:n,valueAlias:r})=>[{name:"source",sql:eT`
        SELECT
            TimeUnix,
            AggregationTemporality,
            ${e},
            ${t?eT`[${t}] AS group,`:""}
            cityHash64(mapConcat(ScopeAttributes, ResourceAttributes, Attributes)) AS attr_hash,
            cityHash64(ExplicitBounds) AS bounds_hash,
            toInt64(Count) AS current_count,
            lagInFrame(toNullable(current_count), 1, NULL) OVER (
                PARTITION BY ${t?"group, ":""} attr_hash, bounds_hash, AggregationTemporality
                ORDER BY TimeUnix
            ) AS prev_count,
            CASE
                WHEN AggregationTemporality = 1 THEN current_count
                WHEN AggregationTemporality = 2 THEN greatest(0, current_count - coalesce(prev_count, 0))
                ELSE 0
            END AS delta
        FROM ${a}
        WHERE ${n}
    `},{name:"metrics",sql:eT`
        SELECT
            \`__hdx_time_bucket\`,
            ${t?"group,":""}
            sum(delta) AS "${r}"
        FROM source
        GROUP BY ${t?"group, ":""}\`__hdx_time_bucket\`
    `}],eU=({timeBucketSelect:e,groupBy:t,from:a,where:n,valueAlias:r,level:i})=>[{name:"source",sql:eT`
          SELECT
            MetricName,
            ExplicitBounds,
            ${e},
            ${t?eT`[${t}] as group,`:""}
            sumForEach(deltas) as rates
          FROM (
            SELECT
              TimeUnix,
              MetricName,
              ResourceAttributes,
              Attributes,
              ExplicitBounds,
              attr_hash,
              any(attr_hash) OVER (ROWS BETWEEN 1 preceding AND 1 preceding) AS prev_attr_hash,
              any(bounds_hash) OVER (ROWS BETWEEN 1 preceding AND 1 preceding) AS prev_bounds_hash,
              any(counts) OVER (ROWS BETWEEN 1 preceding AND 1 preceding) AS prev_counts,
              counts,
              IF(
                  AggregationTemporality = 1 ${""}
                      OR prev_attr_hash != attr_hash ${""}
                      OR bounds_hash != prev_bounds_hash ${""}
                      OR arrayExists((x) -> x.2 < x.1, arrayZip(prev_counts, counts)), ${""}
                  counts,
                  counts - prev_counts
              ) AS deltas
            FROM (
              SELECT
                  TimeUnix,
                  MetricName,
                  AggregationTemporality,
                  ExplicitBounds,
                  ResourceAttributes,
                  Attributes,
                  cityHash64(mapConcat(ScopeAttributes, ResourceAttributes, Attributes)) AS attr_hash,
                  cityHash64(ExplicitBounds) AS bounds_hash,
                  CAST(BucketCounts AS Array(Int64)) counts
              FROM ${a}
              WHERE ${n}
              ORDER BY attr_hash, TimeUnix ASC
            )
          )
          GROUP BY \`__hdx_time_bucket\`, MetricName, ${t?"group, ":""}ExplicitBounds
          ORDER BY \`__hdx_time_bucket\`
          `},{name:"points",sql:eT`
          SELECT
            \`__hdx_time_bucket\`,
            MetricName,
            ${t?"group,":""}
            arrayZipUnaligned(arrayCumSum(rates), ExplicitBounds) as point,
            length(point) as n
          FROM source
          `},{name:"metrics",sql:eT`
          SELECT
            \`__hdx_time_bucket\`,
            MetricName,
            ${t?"group,":""}
            point[n].1 AS total,
            ${{Float64:i}} * total AS rank,
            arrayFirstIndex(x -> if(x.1 > rank, 1, 0), point) AS upper_idx,
            point[upper_idx].1 AS upper_count,
            ifNull(point[upper_idx].2, inf) AS upper_bound,
            CASE
              WHEN upper_idx > 1 THEN point[upper_idx - 1].2
              WHEN point[upper_idx].2 > 0 THEN 0
              ELSE inf
            END AS lower_bound,
            if (
              lower_bound = 0,
              0,
              point[upper_idx - 1].1
            ) AS lower_count,
            CASE
                WHEN upper_bound = inf THEN point[upper_idx - 1].2
                WHEN lower_bound = inf THEN point[1].2
                ELSE lower_bound + (upper_bound - lower_bound) * ((rank - lower_count) / (upper_count - lower_count))
            END AS "${r}"
          FROM points
          WHERE length(point) > 1 AND total > 0
          `}];t.a=eq,t.b=K,t.c=G,t.d=Q,t.e=z,t.f=Y,t.g=J,t.h=function(e){return{...e,operator:X[e.operator]}},t.i=Z,t.j=er,t.k=ep,t.l=eg,t.m=eh,t.n=ef,t.o=ey,t.p=eE,t.q=eA,t.r=eT,t.s=eS,t.t=e_,t.u=eR,t.v=eb,t.w=ew,t.x=eI,t.y=e$,t.z=ex,t.A=eO,t.B=function(e){let t={};if(null==e)return t;try{let a=eO(e),[n]=d.C.call(void 0,a),{sqlWithReplacements:r,replacements:i}=d.i.call(void 0,n),s=new h.Parser().astify(r,{database:"Postgresql",parseOptions:{includeLocations:!0}});for(let[e,a]of(null!=s.columns&&s.columns.forEach(e=>{null!=e.as&&("expr"===e.type&&"column_ref"===e.expr.type?t[e.as]=e.expr.array_index&&o([e,"access",e=>e.expr,"access",e=>e.array_index,"access",e=>e[0],"optionalAccess",e=>e.brackets])?`${e.expr.column.expr.value}['${e.expr.array_index[0].index.value}']`:e.expr.column.expr.value:null!=e.expr.loc?t[e.as]=r.slice(e.expr.loc.start.offset,e.expr.loc.end.offset):console.error("Unknown alias column type",e))}),Object.entries(t)))for(let[n,r]of i)a.includes(n)&&(t[e]=a.replaceAll(n,r))}catch(t){console.error("Error parsing alias map with JSON removed",t,"for query",e)}return t},t.C=ev,t.D=eL,t.E=eF,t.F=3e6,t.G=S,t.H=_,t.I=function(e){return{databaseName:s(o([e,"optionalAccess",e=>e.from,"optionalAccess",e=>e.databaseName]),()=>""),tableName:s(o([e,"optionalAccess",e=>e.from,"optionalAccess",e=>e.tableName]),()=>""),connectionId:s(o([e,"optionalAccess",e=>e.connection]),()=>"")}},t.J=function(e){return{databaseName:s(o([e,"optionalAccess",e=>e.from,"optionalAccess",e=>e.databaseName]),()=>""),tableName:s(o([e,"optionalAccess",e=>e.from,"optionalAccess",e=>e.tableName]),()=>""),connectionId:s(o([e,"optionalAccess",e=>e.connection]),()=>"")}},t.K=b,t.L=w,t.M=q,t.N=U,t.O=H,t.P=W,t.Q=B},43152:(e,t,a)=>{a.d(t,{gT:()=>N,Hx:()=>R,WG:()=>T,zE:()=>v,x5:()=>x,p2:()=>L,nH:()=>F,JD:()=>q,xh:()=>O,wt:()=>b,VH:()=>W,m9:()=>Q,A7:()=>j,qL:()=>C,_t:()=>K,Z7:()=>G,O7:()=>S,ik:()=>H,zg:()=>P,r4:()=>M,eY:()=>$,xu:()=>z,Ht:()=>I,W6:()=>w,GJ:()=>_});var n=a(6029),r=a(75155),i=a(86508),s=a(11370),o=a(76694),l=a.n(o),u=a(80519),c=a.n(u),m=a(6663),d=a(35467),p=a(67270),g=a(76089),h=a(82641),f=a(60665),y=a(35871);let E={"k8s.pod.cpu.utilization":{newName:"k8s.pod.cpu.usage",versionThreshold:"0.125.0"},"k8s.node.cpu.utilization":{newName:"k8s.node.cpu.usage",versionThreshold:"0.125.0"},"container.cpu.utilization":{newName:"container.cpu.usage",versionThreshold:"0.125.0"}};a(9897);var A=a(92917);let N=[{value:"count",label:"Count of Events",isAttributable:!1},{value:"sum",label:"Sum",isAttributable:!1},{value:"p99",label:"99th Percentile"},{value:"p95",label:"95th Percentile"},{value:"p90",label:"90th Percentile"},{value:"p50",label:"Median"},{value:"avg",label:"Average"},{value:"max",label:"Maximum"},{value:"min",label:"Minimum"},{value:"count_distinct",label:"Count Distinct",isAttributable:!1},{value:"any",label:"Any"},{value:"none",label:"Custom"}],T={name:"",select:[{aggFn:"count",aggCondition:"",aggConditionLanguage:"lucene",valueExpression:""}],where:"",whereLanguage:"lucene",displayType:h.t2.Line,granularity:"auto",alignDateRangeToGranularity:!0};function S(e){let t="auto"===e.granularity||null==e.granularity?(0,g.tA)(e.dateRange,80):e.granularity,a=!1===e.alignDateRangeToGranularity?e.dateRange:(0,g.Ol)(e.dateRange,t);return{...e,dateRange:a,dateRangeEndInclusive:!1,granularity:t,limit:{limit:1e5}}}function _(e){let t,a,n=(0,r.c)(7);n[0]!==e?(t=S(e),n[0]=e,n[1]=t):t=n[1];let i=t;return n[2]!==i.dateRange||n[3]!==i.displayType||n[4]!==i.fillNulls||n[5]!==i.granularity?(a={displayType:i.displayType,dateRange:i.dateRange,fillNulls:i.fillNulls,granularity:i.granularity},n[2]=i.dateRange,n[3]=i.displayType,n[4]=i.fillNulls,n[5]=i.granularity,n[6]=a):a=n[6],a}let R=" \xb7 ",b=" (previous)";function C(e){let[t,a]=e.split(" "),n=Number.parseInt(t);switch(a){case"second":return n;case"minute":return 60*n;case"hour":return 60*n*60;case"day":return 60*n*1440;default:return 0}}function w(e,t){let[a,n]=t.split(" "),r=Number.parseInt(a),i=Math.floor;switch(n){case"second":return new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),i(e.getUTCSeconds()/r)*r));case"minute":return new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),i(e.getUTCMinutes()/r)*r));case"hour":return new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),i(e.getUTCHours()/r)*r));case"day":return new Date(1e3*(i(e.getTime()/1e3/60/60/24/r)*r)*86400);default:return e}}function I(e,t,a){let n=[],r=w(e,a),s=C(a);for(;r<t;)n.push(r),r=(0,i.A)(r,{seconds:s});return n}let $=e=>{let t=e.toLowerCase();return["count","countIf","countDistinct","sum","sumIf","avg","avgIf","min","max","any","anyLast","groupArray","groupArrayInsertAt","groupArrayMovingAvg","groupArraySample","groupUniqArray","groupUniqArrayIf","groupArrayIntersect","groupArrayIntersectIf","groupArrayReduce","groupBitmap","groupBitmapIf","groupBitmapOr","groupBitmapXor","quantile","quantileIf","quantileExact","quantileExactWeighted","quantileTiming","quantileTimingWeighted","quantileTDigest","quantileTDigestWeighted","quantileBFloat16","quantileBFloat16Weighted","quantiles","median","medianExact","medianTDigest","medianBFloat16","stddevPop","stddevPopIf","stddevSamp","stddevSampIf","varPop","varPopIf","varSamp","varSampIf","covarPop","covarSamp","corr","uniq","uniqExact","uniqCombined","uniqCombined64","uniqHLL12","uniqTheta","groupBitAnd","groupBitOr","groupBitXor","groupArrayMap","groupArrayTuple","groupArraySorted","topK","topKIf","topKWeighted","argMin","argMax","minMap","maxMap","runningDifference","retention","sequenceCount","sequenceMatch","histogram","simpleLinearRegression","stochasticLinearRegression","categoricalInformationValue","sumMap","sumMapFiltered","sumWithOverflow","entropy","skewPop","skewSamp","kurtPop","kurtSamp"].some(e=>t.includes(e.toLowerCase()+"("))},x={factor:1,output:"number",mantissa:0,thousandSeparated:!0},O={factor:1,output:"number",mantissa:2,thousandSeparated:!0,unit:"ms"},v={output:"percent",mantissa:0},L={output:"percent",mantissa:0},F={output:"byte"},q={output:"byte"};function D(e,t){return(0,d.P1)(e,[d.A2.Number])?.filter(e=>!t.has(e.name))}function U(e){return(0,d.P1)(e,[d.A2.String,d.A2.Map,d.A2.Array])}function M(e){let[t,a]=e,n=(0,s.A)(a,t);return[new Date(t.getTime()-1e3*n),new Date(a.getTime()-1e3*n)]}function k({response:e,lineDataMap:t,tsBucketMap:a,source:n,previousPeriodOffsetSeconds:r,isPreviousPeriod:i,hiddenSeries:s=[]}){let{meta:o,data:l}=e;if(null==o)throw Error("No meta data found in response");let u=(0,d.zo)(o);if(null==u)throw Error(`No timestamp column found with meta: ${JSON.stringify(o)}`);let c=D(o,new Set(s))??[],m=U(o)??[],p=1===c.length,g=m.length>0;for(let e of l){let s=new Date(e[u.name]),o=i?r:0,l=Math.round(s.getTime()/1e3+o);for(let r of c){let s,o=a.get(l);null==o&&(o={[u.name]:l},a.set(l,o));let c=[...p&&g?[]:[r.name],...m.map(t=>e[t.name])].join(R),d=`${c}${b}`,f=i?d:c,y=e[r.name],E="number"==typeof y?y:Number.parseFloat(y);o[f]=E,n&&1===m.length&&m[0].name===(n.kind===h.GL.Log?n.severityTextExpression:n.statusCodeExpression)&&(s=(0,A.aw)(e[m[0].name])),t[f]={dataKey:f,currentPeriodKey:c,previousPeriodKey:d,displayName:f,color:s,isDashed:i}}}}function P({currentPeriodResponse:e,previousPeriodResponse:t,dateRange:a,granularity:n,generateEmptyBuckets:r=!0,source:i,hiddenSeries:s=[],previousPeriodOffsetSeconds:o=0}){let l,u,c=e.meta;if(null==c)throw Error("No meta data found in response");let m=(0,d.zo)(c),p=D(c,new Set(s))??[],g=U(c)??[],h=1===p.length;if(null==m)throw Error(`No timestamp column found with meta: ${JSON.stringify(c)}`);let f=new Map,y={};k({response:e,lineDataMap:y,tsBucketMap:f,source:i,isPreviousPeriod:!1,previousPeriodOffsetSeconds:o,hiddenSeries:s}),null!=t&&k({response:t,lineDataMap:y,tsBucketMap:f,source:i,isPreviousPeriod:!0,previousPeriodOffsetSeconds:o,hiddenSeries:s});let E=(0,A.EA)(),N=Object.values(y).sort((e,t)=>E.findIndex(t=>t===e.color)-E.findIndex(e=>e===t.color));return r&&null!=n&&I(a[0],a[1],n).forEach(e=>{let t=e.getTime()/1e3,a=f.get(t);if(null==a){let e={[m.name]:t};for(let t of N)e[t.dataKey]=0;f.set(t,e)}else{for(let e of N)null==a[e.dataKey]&&(a[e.dataKey]=0);f.set(t,a)}}),{graphResults:Array.from(f.values()).sort((e,t)=>e[m.name]-t[m.name]),timestampColumn:m,lineData:(l=new Map,u=0,N.map(e=>{let t=e.currentPeriodKey;return l.has(t)?e.color=l.get(t):(e.color||(e.color=(0,A.ob)(u++,e.displayName??e.dataKey)),l.set(t,e.color)),e})),groupColumns:g.map(e=>e.name),valueColumns:p.map(e=>e.name),isSingleValueColumn:h}}let V=e=>{if(null==e)return e;if(e.endsWith("_rate"))return V(e.replace("_rate",""));if("p50"===e||"p90"===e||"p95"===e||"p99"===e)return"quantile";if("count_per_sec"===e||"count_per_min"===e||"count_per_hour"===e)return"count";if(["avg","count","count_distinct","last_value","max","min","sum"].includes(e))return e;throw Error(`Unsupported aggregation function in v2: ${e}`)},H=(e,t)=>{let{series:a,granularity:n,dateRange:r,displayType:i="line",fillNulls:s}=e;if(a.length<1)throw Error("series is required");let o=a[0],l="stacked_bar"===i?h.t2.StackedBar:h.t2.Line;if("logs"===o.table)throw Error("IMPLEMENT ME (logs)");if("metrics"===o.table){let e;if(null==t.metric)throw Error("source.metric is required for metrics");return{select:a.map(e=>{let t=e.field??"",[a,n]=t.split(" - ").map(e=>e.trim()),r=function(e){let t=E[e];if(t)return c().format("MetricName IN (?)",[[e,t.newName]])}(a),i=m.fc(h.SX).parse(n?.toLowerCase());return{aggFn:V(e.aggFn),metricType:i,valueExpression:t,metricName:a,metricNameSql:r,aggConditionLanguage:"lucene",aggCondition:e.where}}),from:t.metric?.from,numberFormat:o.numberFormat,groupBy:(e=t.metric,o.groupBy.map(t=>t.startsWith("k8s")?`${e.resourceAttributesExpression}['${t}']`:t).join(",")),dateRange:r,connection:t.metric?.connection,metricTables:t.metric?.metricTables,timestampValueExpression:t.metric?.timestampValueExpression,granularity:n,where:"",fillNulls:s,displayType:l}}throw Error(`unsupported table in v2: ${o.table}`)};function W({source:e,config:t,dateRange:a,groupFilters:n,valueRangeFilter:r}){if(!e?.id)return null;let i=(0,p.bv)(t);if(i&&e?.logSourceId==null)return f.$e.show({color:"yellow",message:"No log source is associated with the selected metric source."}),null;let s=t.where,o=t.whereLanguage||"lucene";0===s.length&&Array.isArray(t.select)&&1===t.select.length&&(s=t.select[0].aggCondition??"",o=t.select[0].aggConditionLanguage??"lucene");let l=[];if(n&&n.length>0&&n.forEach(({column:e,value:t})=>{if(e&&null!=t){let a=`${e} IN (${c().escape(t)})`;l.push({type:"sql",condition:a})}}),r){let{expression:e,value:t,threshold:a=.05}=r;if(!$(e)){let n=`${e} BETWEEN ${c().escape(t*(1-a))} AND ${c().escape(t*(1+a))}`;l.push({type:"sql",condition:n})}}let u=a[0].getTime(),m=a[1].getTime(),d={source:e?.id??"",where:s,whereLanguage:o,filters:JSON.stringify([...t.filters??[],...l]),isLive:"false",from:u.toString(),to:m.toString()};return i&&(d.where="",d.whereLanguage="lucene",d.filters=JSON.stringify([]),d.source=e?.logSourceId??""),t.eventTableSelect&&(d.select=t.eventTableSelect),`/search?${new URLSearchParams(d).toString()}`}function B(e){return e?"string"==typeof e?e.split(",").map(e=>e.trim()):e.map(e=>"string"==typeof e?e:e.valueExpression):[]}function j({row:e,source:t,config:a,dateRange:n}){let r;if(!t?.id)return null;let i=[];B(a.groupBy).forEach(t=>{null!=e[t]&&i.push({column:t,value:e[t]})});let s=a.select?.[0];if(s){let t="string"==typeof s?void 0:s.aggFn;if(N.find(e=>e.value===t)?.isAttributable!==!1){let t="string"==typeof s?s:s.valueExpression,n=new Set(B(a.groupBy)),i=Object.keys(e).find(e=>!n.has(e)),o=i?e[i]:void 0;null!=o&&"number"==typeof o&&(r={expression:t,value:o})}}return W({source:t,config:a,dateRange:n,groupFilters:i,valueRangeFilter:r})}function K(e){return l()(e,["granularity","groupBy"])}function G(e){let t=structuredClone(l()(e,["granularity"]));return t.limit||(t.limit={limit:200}),t.groupBy&&"string"==typeof t.groupBy&&!t.orderBy&&(t.orderBy=t.groupBy),t}function Q({mvOptimizationData:e,originalDateRange:t}){let a=e?.optimizedConfig?.dateRange;if(!a)return null;let r=e?.explanations.find(e=>e.success)?.mvConfig.minGranularity;return(0,n.jsx)(y.A,{originalDateRange:t,effectiveDateRange:a,mvGranularity:r},"date-range-indicator")}function z(e){return!1!==e}},49672:(e,t,a)=>{a.d(t,{VH:()=>p,W:()=>m,fu:()=>d,uI:()=>h});var n=a(75155),r=a(35467),i=a(88459),s=a(12482),o=a(98142),l=a(93108),u=a(6876),c=a(61410);let m=(e={})=>{if(o.VO){let t=(0,l.xZ)();return 0===t.length?(console.warn("No local connection found"),new i.aP({host:"",...e})):new i.aP({host:t[0].host,username:t[0].username,password:t[0].password,...e})}return new i.aP({host:"/api/clickhouse-proxy",...e})},d=(e={})=>{let{data:t}=u.Ay.useMe(),a=t?.team?.queryTimeout;return void 0!==a?e.queryTimeout=a:e.queryTimeout=c.rb,m(e)};function p(e,t){let a,r,i,o,l=(0,n.c)(8),{connectionId:u}=e;l[0]===Symbol.for("react.memo_cache_sentinel")?(a=m(),l[0]=a):a=l[0];let c=a;return l[1]!==u?(r=["direct_datasources/databases",u],i=async()=>await c.query({query:"SHOW DATABASES",connectionId:u}).then(g),l[1]=u,l[2]=r,l[3]=i):(r=l[2],i=l[3]),l[4]!==t||l[5]!==r||l[6]!==i?(o={queryKey:r,queryFn:i,staleTime:3e5,...t},l[4]=t,l[5]=r,l[6]=i,l[7]=o):o=l[7],(0,s.I)(o)}function g(e){return e.json()}function h({database:e,connectionId:t},a){let n=m();return(0,s.I)({queryKey:[`direct_datasources/databases/${e}/tables`,t],queryFn:async()=>{let a=(0,r.kg)`SHOW TABLES FROM ${{Identifier:e}}`;return await n.query({query:a.sql,query_params:a.params,connectionId:t}).then(e=>e.json())},staleTime:3e5,...a})}},57389:(e,t,a)=>{a.d(t,{d:()=>c});var n=a(75155),r=a(2615),i=a(4308),s=a(12482),o=a(49672),l=a(81973),u=a(78550);function c(e,t){let a,c,m,d,p,g=(0,n.c)(16);g[0]!==t?(a=t||{},g[0]=t,g[1]=a):a=g[1];let{enabled:h}=a,f=(0,u.Ge)(),y=(0,o.fu)(),E=e?.source;g[2]!==E?(c={id:E},g[2]=E,g[3]=c):c=g[3];let{data:A,isLoading:N}=(0,l.Fo)(c);g[4]!==e?(m=["optimizationExplanation",e],g[4]=e,g[5]=m):m=g[5],g[6]!==y||g[7]!==e||g[8]!==f||g[9]!==A?(d=async t=>{let{signal:a}=t;return e&&A?await (0,r.bn)(e,f,y,a,A):{explanations:[]}},g[6]=y,g[7]=e,g[8]=f,g[9]=A,g[10]=d):d=g[10];let T=(void 0===h||h)&&!N&&!!e&&!!A;return g[11]!==t||g[12]!==m||g[13]!==d||g[14]!==T?(p={queryKey:m,queryFn:d,placeholderData:i.rX,staleTime:5e3,...t,enabled:T},g[11]=t,g[12]=m,g[13]=d,g[14]=T,g[15]=p):p=g[15],(0,s.I)(p)}},60302:(e,t,a)=>{function n(e,t){return null!=e?e:t()}function r(e){let t,a=e[0],n=1;for(;n<e.length;){let r=e[n],i=e[n+1];if(n+=2,("optionalAccess"===r||"optionalCall"===r)&&null==a)return;"access"===r||"optionalAccess"===r?(t=a,a=i(a)):("call"===r||"optionalCall"===r)&&(a=i((...e)=>a.call(t,...e)),t=void 0)}return a}async function i(e){let t,a=e[0],n=1;for(;n<e.length;){let r=e[n],i=e[n+1];if(n+=2,("optionalAccess"===r||"optionalCall"===r)&&null==a)return;"access"===r||"optionalAccess"===r?(t=a,a=await i(a)):("call"===r||"optionalCall"===r)&&(a=await i((...e)=>a.call(t,...e)),t=void 0)}return a}Object.defineProperty(t,"__esModule",{value:!0});var s=a(55754),o=a(67505),l=a(35362);async function u(e,t,a){try{return!!await i([await a.getColumn({...e,column:t}),"optionalAccess",async e=>e.type,"access",async e=>e.startsWith,"call",async e=>e("SimpleAggregateFunction(")])}catch(e){return!1}}async function c(e,t,a){try{let n=await i([await a.getColumn({...e,column:t}),"optionalAccess",async e=>e.type]);return n?r([n,"access",e=>e.match,"call",e=>e(/^AggregateFunction\(\s*([^(, ]+)\s*\(/),"optionalAccess",e=>e[1]]):void 0}catch(e){return}}async function m(e,t,a,n){return"count"===a?"sum":await u(e,t,n)?a:`${a}Merge`}function d(e,t,a){return e.aggregatedColumns.find(e=>e.aggFn===a&&("count"===e.aggFn||e.sourceColumn===t))}function p(e,t){if(e.minDate&&!t.dateRange)return!1;if(!e.minDate||!t.dateRange)return!0;let[a]=t.dateRange;return a>=new Date(e.minDate)}var g=/\bcount(If)?\s*\(/i;function h(e){return g.test(e.valueExpression)}async function f(e,t,a,n){var r;let{valueExpression:i,aggFn:s}=t,l=s;if(h(t))throw Error("Custom count() expressions are not supported with materialized views.");if(!l)return t;if(!((r=l)&&o.h.safeParse(r).success))throw Error(`Aggregate function ${l} is not valid.`);let u=d(e,"",l);if(u){let e=u.mvColumn,r=await m(a,e,l,n);return{...t,valueExpression:e,aggFn:r}}let p=d(e,i,l);if(!p)throw Error(`The aggregate function ${function(e,t){if("quantile"!==e)return e;switch(t){case .5:return"median";case .9:return"p90";case .95:return"p95";case .99:return"p99";default:return"quantile"}}(l,t.level)} is not available for column '${i}'.`);if("quantile"===t.aggFn&&"level"in t&&"number"==typeof t.level){let e=await c(a,p.mvColumn,n);e&&(l=e)}let g=await m(a,p.mvColumn,l,n);return{...t,valueExpression:p.mvColumn,aggFn:g}}async function y(e,t,a){if(!Array.isArray(e.select))return{errors:["Only array-based select statements are supported."]};if(t.minDate&&!p(t,e))return{errors:["The selected date range includes dates for which this view does not contain data."]};if(!function(e,t){if(!t.granularity&&!t.dateRange)return!0;let a=t.granularity||"auto";if("auto"===a&&!t.dateRange)return!1;let n="auto"===a&&t.dateRange?s.l.call(void 0,t.dateRange):a,r=s.m.call(void 0,n),i=s.m.call(void 0,e.minGranularity);return r>=i&&r%i==0}(t,e))return{errors:[e.granularity?`Granularity must be a multiple of the view's granularity (${t.minGranularity}).`:"The selected date range is too short for the granularity of this materialized view."]};let n={databaseName:t.databaseName,tableName:t.tableName,connectionId:e.connection},r=await Promise.allSettled(e.select.map(e=>f(t,e,n,a))),i=[],o=[];for(let e of r)"rejected"===e.status?o.push(e.reason.message):i.push(e.value);return o.length>0?{errors:o}:{optimizedConfig:{...structuredClone(e),select:i,timestampValueExpression:t.timestampColumn,from:{databaseName:t.databaseName,tableName:t.tableName},..."dateRange"in e&&e.dateRange?{dateRangeEndInclusive:!1,dateRange:s.A.call(void 0,e.dateRange,t.minGranularity)}:{}}}}async function E(e,t,a,r,i,s){let o=[],l;if(e.with){let a=await Promise.all(e.with.map(async e=>e.chartConfig&&e.chartConfig.from.databaseName===s.from.databaseName&&e.chartConfig.from.tableName===s.from.tableName?y(e.chartConfig,i,t):{optimizedConfig:void 0,errors:[]}));a.some(e=>!!e.optimizedConfig)&&(l={...structuredClone(e),with:e.with.map((e,t)=>({...e,chartConfig:n(a[t].optimizedConfig,()=>e.chartConfig)}))}),o.push(...a.flatMap(e=>n(e.errors,()=>[])))}if(e.from.databaseName===s.from.databaseName&&e.from.tableName===s.from.tableName){let a=await y(n(l,()=>e),i,t);a.optimizedConfig&&(l=a.optimizedConfig),o.push(...n(a.errors,()=>[]))}if(l){let{isValid:e,rowEstimate:n=1/0,error:i}=await a.testChartConfigValidity({config:l,metadata:t,opts:{abort_signal:r},querySettings:s.querySettings});if(i&&o.push(i),e)return{optimizedConfig:l,rowEstimate:n,errors:[]}}return{errors:o}}async function A(e,t,a,r,i){let s=n(i.materializedViews,()=>[]),o=await Promise.all(s.map(n=>E(e,t,a,r,n,i).then(e=>({...e,mvConfig:n})))),l,u=1/0;for(let e of o)e.optimizedConfig&&n(e.rowEstimate,()=>1/0)<u&&(l=e.optimizedConfig,u=n(e.rowEstimate,()=>1/0));let c=o.map(({optimizedConfig:e,errors:t,rowEstimate:a,mvConfig:n})=>({success:!!e&&e===l,errors:t,rowEstimate:a,mvConfig:n}));return{optimizedConfig:l,explanations:c}}async function N(e,t,a,r,i){let{optimizedConfig:s}=await A(e,t,a,r,i);return n(s,()=>e)}function T(e){return`${e.databaseName}.${e.tableName}`}async function S({chartConfig:e,keys:t,source:a,clickhouseClient:i,metadata:o,signal:u}){let c=new Map((r([a,"optionalAccess",e=>e.materializedViews])||[]).map(e=>[T(e),e])),m=new Map;for(let[a,n]of c.entries()){let r=e.dateRange?function(e,t){let[a,n]=e,r=s.m.call(void 0,t);return Math.floor(l.differenceInSeconds.call(void 0,n,a)/r)}(e.dateRange,n.minGranularity):1/0;if(p(n,e)&&r>=3){let e=s.e.call(void 0,n.dimensionColumns),r=t.filter(t=>e.includes(t));r.length>0&&m.set(a,r)}}let d=[...m.entries()].map(([t,a])=>{let{databaseName:n,tableName:r,timestampColumn:i}=c.get(t);return{...structuredClone(e),timestampValueExpression:i,from:{databaseName:n,tableName:r},select:a.map((e,t)=>`groupUniqArray(1)(${e}) AS param${t}`).join(", ")}}),g=await Promise.all(d.map(async e=>{let{isValid:t,rowEstimate:n=1/0}=await i.testChartConfigValidity({config:e,metadata:o,opts:{abort_signal:u},querySettings:r([a,"optionalAccess",e=>e.querySettings])});return{id:T({databaseName:e.from.databaseName,tableName:e.from.tableName}),isValid:t,rowEstimate:n}})),h=new Map,f=new Set(t);for(let e of g.filter(e=>e.isValid).sort((e,t)=>e.rowEstimate-t.rowEstimate)){let t=n(m.get(e.id),()=>[]).filter(e=>f.has(e));if(t.length)for(let a of(h.set(e.id,t),t))f.delete(a)}let y=[...h.entries()].map(([t,a])=>{let{databaseName:n,tableName:r,timestampColumn:i}=c.get(t);return{chartConfig:{...structuredClone(e),timestampValueExpression:i,from:{databaseName:n,tableName:r}},keys:a}});return f.size&&y.push({chartConfig:structuredClone(e),keys:[...f]}),y}t.a=h,t.b=y,t.c=A,t.d=N,t.e=S},61410:(e,t,a)=>{a.d(t,{Km:()=>n,Nz:()=>i,rb:()=>r});let n=200,r=60;function i(e){return{limit:{limit:e?.searchRowLimit??n}}}},67270:(e,t,a)=>{var n=a(37823);a(60302),a(55754),a(67505),t.n_=n.b,n.h,t.bv=n.e,t.v4=n.i,t.lE=n.d,t.x1=n.c,t.PV=n.k,n.f,n.g,n.j},69519:(e,t,a)=>{a.d(t,{Me:()=>i,so:()=>r});let n=[21600,21600,43200,86400];function r(e,t,a=n){if(e.getTime()===t.getTime())return[{startTime:e,endTime:t,windowIndex:0,direction:"DESC"}];let i=[],s=new Date(t),o=0;for(;s>e;){let t=1e3*(a[o]||a[a.length-1]),n=new Date(Math.max(s.getTime()-t,e.getTime()));i.push({endTime:new Date(s),startTime:n,windowIndex:o,direction:"DESC"}),s=n,o++}return i}function i(e,t,a=n){if(e.getTime()===t.getTime())return[{startTime:e,endTime:t,windowIndex:0,direction:"ASC"}];let r=[],s=new Date(e),o=0;for(;s<t;){let e=1e3*(a[o]||a[a.length-1]),n=new Date(Math.min(s.getTime()+e,t.getTime()));r.push({startTime:new Date(s),endTime:n,windowIndex:o,direction:"ASC"}),s=n,o++}return r}},73854:(e,t,a)=>{var n=a(67599),r=n.expandPhrases.call(void 0,["SELECT [ALL | DISTINCT]"]),i=n.expandPhrases.call(void 0,["WITH [RECURSIVE]","FROM","WHERE","GROUP BY [ALL | DISTINCT]","HAVING","WINDOW","PARTITION BY","ORDER BY","LIMIT","OFFSET","FETCH {FIRST | NEXT}","INSERT INTO","VALUES","SET"]),s=n.expandPhrases.call(void 0,["CREATE [GLOBAL TEMPORARY | LOCAL TEMPORARY] TABLE"]),o=n.expandPhrases.call(void 0,["CREATE [RECURSIVE] VIEW","UPDATE","WHERE CURRENT OF","DELETE FROM","DROP TABLE","ALTER TABLE","ADD COLUMN","DROP [COLUMN]","RENAME COLUMN","RENAME TO","ALTER [COLUMN]","{SET | DROP} DEFAULT","ADD SCOPE","DROP SCOPE {CASCADE | RESTRICT}","RESTART WITH","TRUNCATE TABLE","SET SCHEMA"]),l={name:"clickhouse",tokenizerOptions:{reservedSelect:r,reservedClauses:[...i,...s,...o],reservedSetOperations:n.expandPhrases.call(void 0,["UNION [ALL | DISTINCT]","EXCEPT [ALL | DISTINCT]","INTERSECT [ALL | DISTINCT]"]),reservedJoins:n.expandPhrases.call(void 0,["JOIN","{LEFT | RIGHT | FULL} [OUTER] JOIN","{INNER | CROSS} JOIN","NATURAL [INNER] JOIN","NATURAL {LEFT | RIGHT | FULL} [OUTER] JOIN"]),reservedPhrases:n.expandPhrases.call(void 0,["ON {UPDATE | DELETE} [SET NULL | SET DEFAULT]","{ROWS | RANGE} BETWEEN"]),reservedKeywords:["ALL","ALLOCATE","ALTER","ANY","ARE","AS","ASC","ASENSITIVE","ASYMMETRIC","AT","ATOMIC","AUTHORIZATION","BEGIN","BETWEEN","BOTH","BY","CALL","CALLED","CASCADED","CAST","CHECK","CLOSE","COALESCE","COLLATE","COLUMN","COMMIT","CONDITION","CONNECT","CONSTRAINT","CORRESPONDING","CREATE","CROSS","CUBE","CURRENT","CURRENT_CATALOG","CURRENT_DEFAULT_TRANSFORM_GROUP","CURRENT_PATH","CURRENT_ROLE","CURRENT_SCHEMA","CURRENT_TRANSFORM_GROUP_FOR_TYPE","CURRENT_USER","CURSOR","CYCLE","DEALLOCATE","DAY","DECLARE","DEFAULT","DELETE","DEREF","DESC","DESCRIBE","DETERMINISTIC","DISCONNECT","DISTINCT","DROP","DYNAMIC","EACH","ELEMENT","END-EXEC","ESCAPE","EVERY","EXCEPT","EXEC","EXECUTE","EXISTS","EXTERNAL","FALSE","FETCH","FILTER","FOR","FOREIGN","FREE","FROM","FULL","FUNCTION","GET","GLOBAL","GRANT","GROUP","HAVING","HOLD","HOUR","IDENTITY","IN","INDICATOR","INNER","INOUT","INSENSITIVE","INSERT","INTERSECT","INTO","IS","LANGUAGE","LARGE","LATERAL","LEADING","LEFT","LIKE","LIKE_REGEX","LOCAL","MATCH","MEMBER","MERGE","METHOD","MINUTE","MODIFIES","MODULE","MONTH","NATURAL","NEW","NO","NONE","NOT","NULL","NULLIF","OF","OLD","ON","ONLY","OPEN","ORDER","OUT","OUTER","OVER","OVERLAPS","PARAMETER","PARTITION","PRECISION","PREPARE","PRIMARY","PROCEDURE","RANGE","READS","REAL","RECURSIVE","REF","REFERENCES","REFERENCING","RELEASE","RESULT","RETURN","RETURNS","REVOKE","RIGHT","ROLLBACK","ROLLUP","ROW","ROWS","SAVEPOINT","SCOPE","SCROLL","SEARCH","SECOND","SELECT","SENSITIVE","SESSION_USER","SET","SIMILAR","SOME","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","START","STATIC","SUBMULTISET","SYMMETRIC","SYSTEM","SYSTEM_USER","TABLE","TABLESAMPLE","THEN","TIMEZONE_HOUR","TIMEZONE_MINUTE","TO","TRAILING","TRANSLATION","TREAT","TRIGGER","TRUE","UESCAPE","UNION","UNIQUE","UNKNOWN","UNNEST","UPDATE","USER","USING","VALUE","VALUES","WHENEVER","WINDOW","WITHIN","WITHOUT","YEAR"],reservedDataTypes:["ARRAY","BIGINT","BINARY LARGE OBJECT","BINARY VARYING","BINARY","BLOB","BOOLEAN","CHAR LARGE OBJECT","CHAR VARYING","CHAR","CHARACTER LARGE OBJECT","CHARACTER VARYING","CHARACTER","CLOB","DATE","DEC","DECIMAL","DOUBLE","FLOAT","INT","INTEGER","INTERVAL","MULTISET","NATIONAL CHAR VARYING","NATIONAL CHAR","NATIONAL CHARACTER LARGE OBJECT","NATIONAL CHARACTER VARYING","NATIONAL CHARACTER","NCHAR LARGE OBJECT","NCHAR VARYING","NCHAR","NCLOB","NUMERIC","SMALLINT","TIME","TIMESTAMP","VARBINARY","VARCHAR"],reservedFunctionNames:["GROUPING","RANK","DENSE_RANK","PERCENT_RANK","CUME_DIST","ROW_NUMBER","POSITION","OCCURRENCES_REGEX","POSITION_REGEX","EXTRACT","CHAR_LENGTH","CHARACTER_LENGTH","OCTET_LENGTH","CARDINALITY","ABS","MOD","LN","EXP","POWER","SQRT","FLOOR","CEIL","CEILING","WIDTH_BUCKET","SUBSTRING","SUBSTRING_REGEX","UPPER","LOWER","CONVERT","TRANSLATE","TRANSLATE_REGEX","TRIM","OVERLAY","NORMALIZE","SPECIFICTYPE","CURRENT_DATE","CURRENT_TIME","LOCALTIME","CURRENT_TIMESTAMP","LOCALTIMESTAMP","COUNT","AVG","MAX","MIN","SUM","STDDEV_POP","STDDEV_SAMP","VAR_SAMP","VAR_POP","COLLECT","FUSION","INTERSECTION","COVAR_POP","COVAR_SAMP","CORR","REGR_SLOPE","REGR_INTERCEPT","REGR_COUNT","REGR_R2","REGR_AVGX","REGR_AVGY","REGR_SXX","REGR_SYY","REGR_SXY","PERCENTILE_CONT","PERCENTILE_DISC","CAST","COALESCE","NULLIF","ROUND","SIN","COS","TAN","ASIN","ACOS","ATAN"],stringTypes:[{quote:"''-qq-bs",prefixes:["N","U&"]},{quote:"''-raw",prefixes:["X"],requirePrefix:!0}],identTypes:['""-qq',"``"],extraParens:["[]"],paramTypes:{positional:!0},operators:["||","%"]},formatOptions:{onelineClauses:[...s,...o],tabularOnelineClauses:o}};t.GP=function(e){return n.formatDialect.call(void 0,e,{dialect:l})}},78550:(e,t,a)=>{a.d(t,{Ii:()=>F,ws:()=>w,Zh:()=>T,lo:()=>L,kN:()=>v,n$:()=>S,Ge:()=>N,Sh:()=>R,nT:()=>$,Z2:()=>I});var n=a(75155),r=a(55729),i=a(79339),s=a.n(i),o=a(35467),l=a(93251),u=a(12482),c=a(4308),m=a(6876),d=a(98142),p=a(93108),g=a(3145),h=a(49672),f=a(61410);let y=()=>(0,g.yb)((0,h.W)({queryTimeout:f.rb}));var E=a(81973),A=a(92917);function N(){let e,t,a,i,s,o=(0,n.c)(10);o[0]===Symbol.for("react.memo_cache_sentinel")?(e=y(),o[0]=e):e=o[0];let[u,c]=(0,r.useState)(e),{data:g}=m.Ay.useMe(),h=(0,r.useRef)(!1),f=(0,l.jE)();o[1]!==f?(t=()=>{if(void 0===window.document||!d.VO)return;let e=e=>{e.key===p.Gs&&e.newValue&&(c(y()),h.current=!1,f.resetQueries())};return window.addEventListener("storage",e),()=>{window.removeEventListener("storage",e)}},a=[f],o[1]=f,o[2]=t,o[3]=a):(t=o[2],a=o[3]),(0,r.useEffect)(t,a),o[4]!==g||o[5]!==u?(i=()=>{g?.team?.metadataMaxRowsToRead&&!h.current&&(u.setClickHouseSettings({max_rows_to_read:g.team.metadataMaxRowsToRead}),h.current=!0)},o[4]=g,o[5]=u,o[6]=i):i=o[6];let E=g?.team?.metadataMaxRowsToRead;return o[7]!==u||o[8]!==E?(s=[E,u],o[7]=u,o[8]=E,o[9]=s):s=o[9],(0,r.useEffect)(i,s),u}function T(e,t){let a,r,i,s=(0,n.c)(13),{databaseName:o,tableName:l,connectionId:c}=e,m=N();s[0]!==o||s[1]!==l?(a=["useMetadata.useColumns",{databaseName:o,tableName:l}],s[0]=o,s[1]=l,s[2]=a):a=s[2],s[3]!==c||s[4]!==o||s[5]!==m||s[6]!==l?(r=async()=>m.getColumns({databaseName:o,tableName:l,connectionId:c}),s[3]=c,s[4]=o,s[5]=m,s[6]=l,s[7]=r):r=s[7];let d=!!o&&!!l&&!!c;return s[8]!==t||s[9]!==a||s[10]!==r||s[11]!==d?(i={queryKey:a,queryFn:r,enabled:d,...t},s[8]=t,s[9]=a,s[10]=r,s[11]=d,s[12]=i):i=s[12],(0,u.I)(i)}function S(e,t){let a,r,i,s=(0,n.c)(10),l=N();s[0]!==e?(a=["useMetadata.useJsonColumns",e],s[0]=e,s[1]=a):a=s[1],s[2]!==l||s[3]!==e?(r=async()=>{if(!e)return[];let t=await l.getColumns(e);return(0,o.P1)(t,[o.A2.JSON])?.map(_)??[]},s[2]=l,s[3]=e,s[4]=r):r=s[4];let c=e&&!!e.databaseName&&!!e.tableName&&!!e.connectionId;return s[5]!==t||s[6]!==a||s[7]!==r||s[8]!==c?(i={queryKey:a,queryFn:r,enabled:c,...t},s[5]=t,s[6]=a,s[7]=r,s[8]=c,s[9]=i):i=s[9],(0,u.I)(i)}function _(e){return e.name}function R(e,t){let a,r,i,s,o=(0,n.c)(14),l=N(),{data:c,isFetched:d}=m.Ay.useMe();return o[0]!==e?(a=["useMetadata.useMultipleAllFields",...e.map(C)],o[0]=e,o[1]=a):a=o[1],o[2]!==c?.team||o[3]!==l||o[4]!==e?(r=async()=>{let t=c?.team;if(t?.fieldMetadataDisabled)return[];let a=await Promise.all(e.map(e=>l.getAllFields(e)));return 1===a.length?a[0]:F(a)},o[2]=c?.team,o[3]=l,o[4]=e,o[5]=r):r=o[5],o[6]!==d||o[7]!==e?(i=e.length>0&&e.every(b)&&d,o[6]=d,o[7]=e,o[8]=i):i=o[8],o[9]!==t||o[10]!==a||o[11]!==r||o[12]!==i?(s={queryKey:a,queryFn:r,enabled:i,...t},o[9]=t,o[10]=a,o[11]=r,o[12]=i,o[13]=s):s=o[13],(0,u.I)(s)}function b(e){return!!e.databaseName&&!!e.tableName&&!!e.connectionId}function C(e){return{...e}}function w(e,t){let a,r=(0,n.c)(2);return r[0]!==e?(a=e?[e]:[],r[0]=e,r[1]=a):a=r[1],R(a,t)}function I(e,t){let a,r,i,s=(0,n.c)(13),{databaseName:o,tableName:l,connectionId:c}=e,m=N();s[0]!==o||s[1]!==l?(a=["useMetadata.useTableMetadata",{databaseName:o,tableName:l}],s[0]=o,s[1]=l,s[2]=a):a=s[2],s[3]!==c||s[4]!==o||s[5]!==m||s[6]!==l?(r=async()=>await m.getTableMetadata({databaseName:o,tableName:l,connectionId:c}),s[3]=c,s[4]=o,s[5]=m,s[6]=l,s[7]=r):r=s[7];let d=!!o&&!!l&&!!c;return s[8]!==t||s[9]!==a||s[10]!==r||s[11]!==d?(i={queryKey:a,queryFn:r,staleTime:3e5,enabled:d,...t},s[8]=t,s[9]=a,s[10]=r,s[11]=d,s[12]=i):i=s[12],(0,u.I)(i)}function $(e,t){let a,r,i,s=(0,n.c)(12),{chartConfigs:o,keys:l,limit:m,disableRowLimit:d}=e,p=N(),g=(0,A.$r)(o);s[0]!==t?(a=t||{},s[0]=t,s[1]=a):a=s[1];let{enabled:h}=a,{data:f,isLoading:y}=(0,E.oE)();s[2]!==g||s[3]!==d||s[4]!==l||s[5]!==m||s[6]!==p||s[7]!==f?(r=async e=>{let{signal:t}=e;return(await Promise.all(g.map(e=>{let a=e.source?f?.find(t=>t.id===e.source):void 0;return p.getKeyValuesWithMVs({chartConfig:e,keys:l.slice(0,20),limit:m,disableRowLimit:d,source:a,signal:t})}))).flatMap(x)},s[2]=g,s[3]=d,s[4]=l,s[5]=m,s[6]=p,s[7]=f,s[8]=r):r=s[8];let T=(0,u.I)({queryKey:["useMetadata.useGetKeyValues",...g.map(O),...l,d],queryFn:r,staleTime:3e5,placeholderData:c.rX,...t,enabled:!!(void 0===h||h)&&!!l.length&&!y}),S=T.isLoading||y;return s[9]!==T||s[10]!==S?(i={...T,isLoading:S},s[9]=T,s[10]=S,s[11]=i):i=s[11],i}function x(e){return e}function O(e){return{...e}}function v(e,t){let a,r,i,s,o=(0,n.c)(16),{chartConfig:l,key:m,limit:d}=e,p=N();o[0]!==l.source?(a={id:l.source},o[0]=l.source,o[1]=a):a=o[1];let{data:g,isLoading:h}=(0,E.Fo)(a);o[2]!==l||o[3]!==m?(r=["useMetadata.useGetValuesDistribution",l,m],o[2]=l,o[3]=m,o[4]=r):r=o[4],o[5]!==l||o[6]!==m||o[7]!==d||o[8]!==p||o[9]!==g?(i=async()=>await p.getValuesDistribution({chartConfig:l,key:m,limit:d,source:g}),o[5]=l,o[6]=m,o[7]=d,o[8]=p,o[9]=g,o[10]=i):i=o[10];let f=!!m&&!h;return o[11]!==t||o[12]!==r||o[13]!==i||o[14]!==f?(s={queryKey:r,queryFn:i,staleTime:1/0,enabled:f,placeholderData:c.rX,retry:!1,...t},o[11]=t,o[12]=r,o[13]=i,o[14]=f,o[15]=s):s=o[15],(0,u.I)(s)}function L(e,t){let a,r,i=(0,n.c)(7),{chartConfig:s,keys:o,limit:l,disableRowLimit:u}=e;return i[0]!==s?(a=s?[s]:[],i[0]=s,i[1]=a):a=i[1],i[2]!==u||i[3]!==o||i[4]!==l||i[5]!==a?(r={chartConfigs:a,keys:o,limit:l,disableRowLimit:u},i[2]=u,i[3]=o,i[4]=l,i[5]=a,i[6]=r):r=i[6],$(r,t)}function F(e){let t=[],a=new Set;for(let n of e)for(let e of n){let n=s().sha1(e);a.has(n)||(a.add(n),t.push(e))}return t}},81973:(e,t,a)=>{a.d(t,{AF:()=>R,Al:()=>j,Dp:()=>V,Fo:()=>O,N8:()=>w,YI:()=>U,Ys:()=>P,fS:()=>B,kJ:()=>A,kg:()=>H,nd:()=>q,oE:()=>$,pM:()=>b,sr:()=>L,xg:()=>C});var n=a(75155),r=a(29594),i=a.n(r),s=a(79339),o=a.n(s),l=a(91985),u=a.n(l),c=a(35467),m=a(76089),d=a(82641),p=a(12482),g=a(93251),h=a(16932),f=a(6876),y=a(98142),E=a(92917);let A={resourceAttributesExpression:"ResourceAttributes",eventAttributesExpression:"LogAttributes",timestampValueExpression:"TimestampTime",implicitColumnExpression:"Body"},N={...A,timestampValueExpression:"Timestamp"},T="hdx-local-source";function S(e){u().transact(T,e,[])}function _(){if(u().has(T))return u().get(T,[])??[];try{let e=(0,E.Ol)(y.m6??"");if(null!=e)return e}catch(e){console.error("Error fetching default sources",e)}return[]}function R(e){return(0,m.AB)(e)[0]}function b(e){return e.spanNameExpression}function C(e){return e.displayedTimestampValueExpression??R(e.timestampValueExpression)}function w(e){let t=e.kind===d.GL.Trace?e.spanNameExpression??void 0:e.bodyExpression??e.implicitColumnExpression,a=(0,m.AB)(t??"");return 1===a.length?t:a[0]}function I(e){return{...e,timestampValueExpression:e.kind===d.GL.Session?e.timestampValueExpression||A.timestampValueExpression:e.timestampValueExpression}}function $(){let e,t=(0,n.c)(1);return t[0]===Symbol.for("react.memo_cache_sentinel")?(e={queryKey:["sources"],queryFn:x},t[0]=e):e=t[0],(0,p.I)(e)}async function x(){return y.VO?_():(await (0,f.Q5)("sources").json()).map(I)}function O(e){let t,a,r,i=(0,n.c)(6),{id:s}=e;i[0]===Symbol.for("react.memo_cache_sentinel")?(t=["sources"],i[0]=t):t=i[0],i[1]!==s?(a=e=>e.filter(e=>e.id===s)[0],i[1]=s,i[2]=a):a=i[2];let o=null!=s;return i[3]!==a||i[4]!==o?(r={queryKey:t,queryFn:v,select:a,enabled:o},i[3]=a,i[4]=o,i[5]=r):r=i[5],(0,p.I)(r)}async function v(){return y.VO?_():(await (0,f.Q5)("sources").json()).map(I)}function L(){let e,t=(0,n.c)(2),a=(0,g.jE)();return t[0]!==a?(e={mutationFn:F,onSuccess:()=>{a.invalidateQueries({queryKey:["sources"]})}},t[0]=a,t[1]=e):e=t[1],(0,h.n)(e)}async function F(e){let{source:t}=e;if(!y.VO)return await (0,f.Q5)(`sources/${t.id}`,{method:"PUT",json:t});S(e=>e.map(e=>e.id===t.id?t:e))}function q(){let e,t=(0,n.c)(2),a=(0,g.jE)();return t[0]!==a?(e={mutationFn:D,onSuccess:()=>{a.invalidateQueries({queryKey:["sources"]})}},t[0]=a,t[1]=e):e=t[1],(0,h.n)(e)}async function D(e){let{source:t}=e;if(y.VO){let e=_().find(e=>o()(i()(e,["kind","name","connection"]))===o()(i()(t,["kind","name","connection"])));if(e)return{...t,id:e.id};let a={...t,id:`l${(0,m.s5)(Math.random().toString())}`};return S(e=>[...e,a]),a}return(0,f.Q5)("sources",{method:"POST",json:t}).json()}function U(){let e,t=(0,n.c)(2),a=(0,g.jE)();return t[0]!==a?(e={mutationFn:M,onSuccess:()=>{a.invalidateQueries({queryKey:["sources"]})}},t[0]=a,t[1]=e):e=t[1],(0,h.n)(e)}async function M(e){let{id:t}=e;return y.VO?void S(e=>e.filter(e=>e.id!==t)):(0,f.Q5)(`sources/${t}`,{method:"DELETE"})}function k(e,t){let a=new Map(e.map(e=>[e.name,e]));return 0===Array.from(t).filter(e=>!a.has(e)).length}async function P({databaseName:e,tableName:t,connectionId:a,metadata:n}){let r=await n.getColumns({databaseName:e,tableName:t,connectionId:a}),i=(await n.getTableMetadata({databaseName:e,tableName:t,connectionId:a})).primary_key,s=new Set((0,c.bZ)(i)),o=k(r,["Timestamp","Body","SeverityText","TraceId","SpanId","ServiceName","LogAttributes","ResourceAttributes"]),l=k(r,["Timestamp","SpanName","Duration","SpanKind","TraceId","SpanId","ParentSpanId","ServiceName","SpanAttributes","ResourceAttributes","StatusCode","StatusMessage"]),u=r.some(e=>"Events.Timestamp"===e.name),m=(0,c.P1)(r,[c.A2.Date]),d=m?.find(e=>s.has(e.name));return{...null!=d?{timestampValueExpression:d.name}:{},...o?{defaultTableSelectExpression:"Timestamp, ServiceName as service, SeverityText as level, Body",serviceNameExpression:"ServiceName",bodyExpression:"Body",displayedTimestampValueExpression:"Timestamp",eventAttributesExpression:"LogAttributes",implicitColumnExpression:"Body",resourceAttributesExpression:"ResourceAttributes",spanIdExpression:"SpanId",traceIdExpression:"TraceId",severityTextExpression:"SeverityText"}:{},...l?{displayedTimestampValueExpression:"Timestamp",implicitColumnExpression:"SpanName",defaultTableSelectExpression:"Timestamp, ServiceName as service, StatusCode as level, round(Duration / 1e6) as duration, SpanName",eventAttributesExpression:"SpanAttributes",serviceNameExpression:"ServiceName",resourceAttributesExpression:"ResourceAttributes",durationExpression:"Duration",durationPrecision:9,parentSpanIdExpression:"ParentSpanId",spanIdExpression:"SpanId",spanKindExpression:"SpanKind",spanNameExpression:"SpanName",traceIdExpression:"TraceId",statusCodeExpression:"StatusCode",statusMessageExpression:"StatusMessage",...u?{spanEventsValueExpression:"Events"}:{}}:{}}}function V(e){return`(${e.durationExpression})/1e${(e.durationPrecision??9)-3}`}function H(e){return`(${e.durationExpression})/1e${e.durationPrecision??9}`}let W={[d.SX.Gauge]:["TimeUnix","ServiceName","MetricName","Value","Attributes","ResourceAttributes"],[d.SX.Histogram]:["TimeUnix","ServiceName","MetricName","Attributes","ResourceAttributes","Count","Sum","BucketCounts","ExplicitBounds"],[d.SX.Sum]:["TimeUnix","ServiceName","MetricName","Value","Attributes","ResourceAttributes"],[d.SX.Summary]:["Attributes","TimeUnix","Count","Sum","ValueAtQuantiles.Quantile","ValueAtQuantiles.Value","Flags","ServiceName","MetricName","ResourceAttributes"],[d.SX.ExponentialHistogram]:["Attributes","TimeUnix","Count","Sum","Scale","ZeroCount","PositiveOffset","PositiveBucketCounts","NegativeOffset","NegativeBucketCounts","Flags","ServiceName","MetricName","ResourceAttributes"]};async function B({databaseName:e,tableName:t,connectionId:a,metricType:n,metadata:r}){return!!t&&k(await r.getColumns({databaseName:e,tableName:t,connectionId:a}),W[n])}async function j({databaseName:e,tableName:t,connectionId:a,metadata:n}){if(!t)return!1;let r=await n.getColumns({databaseName:e,tableName:t,connectionId:a});return k(r,Object.values(A))||k(r,Object.values(N))}},82641:(e,t,a)=>{var n=a(67505);n.g,n.i,n.A,t.lZ=n.v,n.C,t.w5=n.u,t.Or=n.t,t.qQ=n.s,n.$,n.aa,n.p,t.fB=n.B,n.J,n.U,n.I,n.O,n.N,n.R,t.mJ=n.T,n.S,n.k,t.t2=n.b,n.E,n.h,n.o,n.Y,n.c,t.SX=n.a,n.G,t.K5=n.P,n.Q,n.j,n.d,n.K,n.F,n.f,n.e,n.l,n.q,n.n,n.m,t.GL=n.X,n.Z,n.D,n.V,n.W,n.L,n.M,t.x=n.r,n.H,t.z1=n._,t.Oq=n.x,n.w,n.y,n.z},88459:(e,t,a)=>{function n(e){let t,a=e[0],n=1;for(;n<e.length;){let r=e[n],i=e[n+1];if(n+=2,("optionalAccess"===r||"optionalCall"===r)&&null==a)return;"access"===r||"optionalAccess"===r?(t=a,a=i(a)):("call"===r||"optionalCall"===r)&&(a=i((...e)=>a.call(t,...e)),t=void 0)}return a}function r(e){let t=n(e);return null==t||t}var i=a(37823);a(60302),a(55754),a(67505);var s=a(5216),o=(e,t)=>{t||(t={});let a=new URL(e instanceof URL?e:e instanceof Request?e.url:e),i=n([t,"access",e=>e.headers,"optionalAccess",e=>e.Authorization]),[s,o]=window.atob(i.substring(6)).split(":");return r([t,"access",e=>e.headers,"optionalAccess",e=>delete e.Authorization]),r([t,"access",e=>e.headers,"optionalAccess",e=>delete e.authorization]),s&&a.searchParams.set("user",s),o&&a.searchParams.set("password",o),fetch(`${a.toString()}`,t)},l=(e,t)=>(t||(t={}),r([t,"access",e=>e.headers,"optionalAccess",e=>delete e.Authorization]),r([t,"access",e=>e.headers,"optionalAccess",e=>delete e.authorization]),fetch(e,t)),u=t.Kc=async({host:e,username:t,password:a})=>{try{return(await new c({host:e,username:t,password:a}).query({query:"SELECT 1",format:"TabSeparatedRaw"})).text().then(e=>"1"===e.trim())}catch(e){return console.warn("Failed to test local connection",e),!1}},c=t.aP=class extends i.y{constructor(e){super(e)}buildClient(){var e,t,a,n;let r=this.host,i,u=null!=this.username&&null!=this.password,c={};u?(i=o,c.add_http_cors_header=1):(r=`${window.origin}${this.host}`,i=l);let m=new URL(r);return s.createClient.call(void 0,{url:m.origin,pathname:m.pathname,clickhouse_settings:c,username:(e=this.username,t=()=>"",null!=e?e:t()),password:(a=this.password,n=()=>"",null!=a?a:n()),keep_alive:{enabled:!1},fetch:i,request_timeout:this.requestTimeout,application:this.application})}async __query({query:e,format:t="JSON",query_params:a={},abort_signal:n,clickhouse_settings:r,connectionId:i,queryId:s}){null==this.client&&(this.client=this.buildClient()),this.logDebugQuery(e,a);let o=this.processClickhouseSettings(r),l={...i&&"local"!==i?{"x-hyperdx-connection-id":i}:{}};return this.getClient().query({query:e,query_params:a,format:t,abort_signal:n,http_headers:l,clickhouse_settings:o,query_id:s})}};t.aP=c,t.Kc=u},91021:(e,t,a)=>{a.d(t,{Kc:()=>b,HD:()=>_,zu:()=>R});var n=a(75155),r=a(35467),i=a(67270),s=a(76089),o=a(73854),l=a(93251),u=a(12482),c=a(43152),m=a(49672),d=a(98142),p=a(79339),g=a.n(p);let h="hyperdx",f=e=>{let t=g().sha1(e),a=(0,i.v4)(e.aggCondition);switch(e.aggFn){case"min":case"max":case"sum":case"avg":return{fieldName:t,fn:`${e.aggFn}${a?"If":""}`,args:["Nullable(Float64)",...a?["UInt8"]:[]]};case"count":return{fieldName:t,fn:`${e.aggFn}${a?"If":""}`,args:a?["UInt8"]:[]};default:throw Error(`Unsupported aggregation function: ${e.aggFn}`)}},y=async(e,t,a,n)=>{let s,o={...e,...Array.isArray(e.select)&&{select:e.select.map(e=>{let{fieldName:t,fn:a}=f(e);return{...e,aggFn:`${a}State`,alias:t}})},granularity:n??e.granularity,dateRange:void 0,orderBy:void 0,limit:void 0},l=await (0,i.PV)(o,t,a),u=g().sha1(l),c=`${e.from.tableName}_mv_${u}`,m={...e,...Array.isArray(e.select)&&{select:e.select.map(e=>{let{fieldName:t,fn:a}=f(e);return{aggFn:`${a}Merge`,valueExpression:t,alias:`${e.aggFn}(${e.valueExpression})`}})},timestampValueExpression:i.n_,from:{databaseName:h,tableName:c}};return{mtViewName:c,dataTableDDL:(0,r.l6)(((e,t)=>{if(!Array.isArray(t.select))throw Error("Only array select is supported");if((0,i.x1)(t))throw Error("Group by is not supported");return(0,r.kg)`CREATE TABLE IF NOT EXISTS ${h}.${{Identifier:e}}
      (
        ${{Identifier:i.n_}} DateTime,
        ${t.select.map(e=>{let{args:t,fieldName:a,fn:n}=f(e),r=[n,...t].join(",");return`${a} AggregateFunction(${r})`}).join(",\n")}
      )
      ENGINE = AggregatingMergeTree
      ORDER BY ${{Identifier:i.n_}}
      SETTINGS index_granularity = 8192
      `})(`${c}_data`,e)),mtViewDDL:(0,r.l6)((s=`${c}_data`,(0,r.kg)`CREATE MATERIALIZED VIEW IF NOT EXISTS ${h}.${{Identifier:c}} TO ${h}.${{Identifier:s}} AS
      ${l}
    `)),renderMTViewConfig:async()=>{try{return await (0,i.PV)(m,t,a)}catch(e){return console.error("Failed to render MTView config",e),null}}}};var E=a(78550),A=a(81973),N=a(69519),T=a(57389);async function*S({config:e,clickhouseClient:t,signal:a,enableQueryChunking:n=!1,enableParallelQueries:r=!1,metadata:o,querySettings:l}){let u=n&&!(!(0,i.lE)(e)||!e.dateRange||(0,i.bv)(e))&&1?((e,t)=>{let[a,n]=e.dateRange,r=(0,N.so)(a,n,void 0),i="auto"===e.granularity?(0,s.tA)(e.dateRange):e.granularity,o=[];for(let[t,a]of r.entries()){let s=t===r.length-1?a.startTime:(0,c.W6)(a.startTime,i),l=0===t?n:(0,c.W6)(a.endTime,i);(!o.length||s<o[o.length-1].dateRange[0])&&o.push({dateRange:[s,l],dateRangeEndInclusive:0===t&&e.dateRangeEndInclusive})}return o})(e):[void 0];if(d.HT){let{dataTableDDL:t,mtViewDDL:a,renderMTViewConfig:n}=await y(e,o,l);console.log("dataTableDDL:",t),console.log("mtViewDDL:",a),await n()}if(r){let n=u.map(async(n,r)=>{let i={...e,...n??{}};return{index:r,queryResult:await t.queryChartConfig({config:i,metadata:o,opts:{abort_signal:a},querySettings:l})}}),r=[...n],i=Array(u.length),s=0;for(let e=0;e<n.length;e++){let{index:e,queryResult:t}=await Promise.race(r);i[e-s]=t;let a=r.indexOf(n[e]);for(r.splice(a,1);i.length>0&&void 0!==i[0];){let e=i.shift();yield{chunk:e,isComplete:0===i.length},s+=1}}return}for(let n=0;n<u.length;n++){let r=u[n],i={...e,...r??{}},s=await t.queryChartConfig({config:i,metadata:o,opts:{abort_signal:a},querySettings:l});yield{chunk:s,isComplete:n===u.length-1}}}function _(e,t){let{enabled:a=!0}=t??{},n=(0,m.fu)(),r=(0,l.jE)(),i=(0,E.Ge)(),{data:s,isLoading:o}=(0,T.d)(e,{enabled:!!a,placeholderData:void 0}),{data:c,isLoading:d}=(0,A.Fo)({id:e.source}),p=(0,u.I)({queryKey:[e,t?.enableQueryChunking??!1,t?.enableParallelQueries??!1],queryFn:async a=>{let o=s?.optimizedConfig??e,l=r.getQueryCache().find({queryKey:a.queryKey,exact:!0}),u=!!l&&void 0!==l.state.data,m=S({config:o,clickhouseClient:n,signal:a.signal,enableQueryChunking:t?.enableQueryChunking,enableParallelQueries:t?.enableParallelQueries,metadata:i,querySettings:c?.querySettings}),d={data:[],meta:[],rows:0,isComplete:!1};for await(let e of m){if(a.signal.aborted)break;d=function(e,{chunk:t,isComplete:a}){return{data:[...t.data||[],...e?.data||[]],meta:t.meta,rows:(e?.rows||0)+(t.rows||0),isComplete:a}}(d,e),u||r.setQueryData(a.queryKey,d)}return u&&!a.signal.aborted&&r.setQueryData(a.queryKey,d),r.getQueryData(a.queryKey)},retry:1,refetchOnWindowFocus:!1,...t,enabled:a&&!o&&!d});return p.isError&&t?.onError&&t.onError(p.error),{...p,isLoading:p.isLoading||o}}function R(e,t){let a,s,l,c,m,d,p,g=(0,n.c)(21);g[0]!==t?(a=t??{},g[0]=t,g[1]=a):a=g[1];let{enabled:h}=a,f=void 0===h||h,y=(0,E.Ge)(),N=!!f;g[2]!==N?(s={enabled:N,placeholderData:void 0},g[2]=N,g[3]=s):s=g[3];let{data:S,isLoading:_}=(0,T.d)(e,s);g[4]!==e.source?(l={id:e.source},g[4]=e.source,g[5]=l):l=g[5];let{data:R,isLoading:b}=(0,A.Fo)(l);g[6]!==e?(c=["renderedSql",e],g[6]=e,g[7]=c):c=g[7],g[8]!==e||g[9]!==y||g[10]!==S?.optimizedConfig||g[11]!==R?.querySettings?(m=async()=>{let t=S?.optimizedConfig??e,a=await (0,i.PV)(t,y,R?.querySettings);return(0,o.GP)((0,r.l6)(a))},g[8]=e,g[9]=y,g[10]=S?.optimizedConfig,g[11]=R?.querySettings,g[12]=m):m=g[12];let C=f&&!_&&!b;g[13]!==t||g[14]!==c||g[15]!==m||g[16]!==C?(d={queryKey:c,queryFn:m,...t,enabled:C},g[13]=t,g[14]=c,g[15]=m,g[16]=C,g[17]=d):d=g[17];let w=(0,u.I)(d),I=w.isLoading||_;return g[18]!==w||g[19]!==I?(p={...w,isLoading:I},g[18]=w,g[19]=I,g[20]=p):p=g[20],p}function b(e,t){let a,s,o,l,c=(0,n.c)(20);c[0]!==e?(a=e?.dateRange&&(0,i.lE)(e)?e.dateRange[1].getTime()-e.dateRange[0].getTime():void 0,c[0]=e,c[1]=a):a=c[1];let m=a,d=(0,E.Ge)(),p=e?.select,g=e?.from,h=e?.connection,f=e?.with,y=e?.groupBy,A=e?.selectGroupBy,N=e?.granularity,T=e?.seriesReturnType;c[2]!==m||c[3]!==p||c[4]!==g||c[5]!==h||c[6]!==f||c[7]!==y||c[8]!==A||c[9]!==N||c[10]!==T?(s=["aliasMap",p,g,h,f,y,A,N,T,m],c[2]=m,c[3]=p,c[4]=g,c[5]=h,c[6]=f,c[7]=y,c[8]=A,c[9]=N,c[10]=T,c[11]=s):s=c[11],c[12]!==e||c[13]!==d?(o=async()=>{if(null==e)return{};let t=await (0,i.PV)(e,d,void 0);return(0,r.D7)(t)},c[12]=e,c[13]=d,c[14]=o):o=c[14];let S=null!=e;return c[15]!==t||c[16]!==o||c[17]!==S||c[18]!==s?(l={queryKey:s,queryFn:o,enabled:S,...t},c[15]=t,c[16]=o,c[17]=S,c[18]=s,c[19]=l):l=c[19],(0,u.I)(l)}},93108:(e,t,a)=>{a.d(t,{Gs:()=>p,Ir:()=>E,PQ:()=>S,ZY:()=>f,Zm:()=>N,xZ:()=>h});var n=a(75155),r=a(91985),i=a.n(r),s=a(88459),o=a(12482),l=a(93251),u=a(16932),c=a(6876),m=a(98142),d=a(92917);let p="connections";function g(e){let t=new StorageEvent("storage",{key:p,oldValue:i().session.get(p),newValue:JSON.stringify(e),storageArea:window.sessionStorage,url:window.location.href});i().session.set(p,e),window.dispatchEvent(t)}function h(){if(i().session.has(p))return i().session.get(p)??[];try{let e=(0,d.Ol)(m.$E??"");if(null!=e)return e}catch(e){console.error("Error fetching default connections",e)}return[]}function f(){let e,t=(0,n.c)(1);return t[0]===Symbol.for("react.memo_cache_sentinel")?(e={queryKey:["connections"],queryFn:y},t[0]=e):e=t[0],(0,o.I)(e)}function y(){return m.VO?h():(0,c.Q5)("connections").json()}function E(){let e,t=(0,n.c)(2),a=(0,l.jE)();return t[0]!==a?(e={mutationFn:A,onSuccess:()=>{a.invalidateQueries({queryKey:["connections"]})}},t[0]=a,t[1]=e):e=t[1],(0,u.n)(e)}async function A(e){let{connection:t}=e;if(m.VO){if(!await (0,s.Kc)({host:t.host,username:t.username,password:t.password??""}))throw Error("Could not connect to Clickhouse with connection details");let e={id:"local"};return g([{...t,...e}]),e}return await (0,c.Q5)("connections",{method:"POST",json:t}).json()}function N(){let e,t=(0,n.c)(2),a=(0,l.jE)();return t[0]!==a?(e={mutationFn:T,onSuccess:()=>{a.invalidateQueries({queryKey:["connections"]})}},t[0]=a,t[1]=e):e=t[1],(0,u.n)(e)}async function T(e){let{connection:t,id:a}=e;m.VO?g([{...t,id:"local"}]):await (0,c.Q5)(`connections/${a}`,{method:"PUT",json:t})}function S(){let e,t=(0,n.c)(2),a=(0,l.jE)();return t[0]!==a?(e={mutationFn:_,onSuccess:()=>{a.invalidateQueries({queryKey:["connections"]})}},t[0]=a,t[1]=e):e=t[1],(0,u.n)(e)}async function _(e){let{id:t}=e;m.VO?g(h().filter(e=>e.id!==t)):await (0,c.Q5)(`connections/${t}`,{method:"DELETE"})}}}]);