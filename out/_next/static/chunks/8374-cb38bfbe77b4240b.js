(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8374],{57478:(e,t,s)=>{"use strict";s.d(t,{J:()=>h,W:()=>v});var r=s(6029),a=s(75155),n=s(55729),i=s(8737),o=s(48259),l=s(17283),c=s(9211),u=s(98142),d=s(81973),m=s(89011),p=s.n(m);let h=({sourceSchemaPreview:e})=>e?{rightSection:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(i.N,{onClick:e=>{e.stopPropagation(),e.preventDefault()},className:p().sourceSchemaPreviewButton,children:e}),(0,r.jsx)(o.l,{})]}),rightSectionWidth:70}:{rightSection:(0,r.jsx)(o.l,{})};function g(e,t){return e.label.localeCompare(t.label)}function x(e){return{value:e.id,label:e.name}}let v=(0,n.memo)(function(e){let t,s,n,i,o,m,p,v,f,S,y,b=(0,a.c)(25);b[0]!==e?({size:o,onCreate:n,allowedSourceKinds:t,comboboxProps:s,sourceSchemaPreview:m,...i}=e,b[0]=e,b[1]=t,b[2]=s,b[3]=n,b[4]=i,b[5]=o,b[6]=m):(t=b[1],s=b[2],n=b[3],i=b[4],o=b[5],m=b[6]);let{data:j}=(0,d.oE)(),C=!!u.m6;if(b[7]!==t||b[8]!==j||b[9]!==n){let e;b[11]!==n?(e=n&&!C?[{value:"_create_new_value",label:"Create New Source"}]:[],b[11]=n,b[12]=e):e=b[12],p=[...(j?.filter(e=>!t||t.includes(e.kind)).map(x)??[]).sort(g),...e],b[7]=t,b[8]=j,b[9]=n,b[10]=p}else p=b[10];let _=p;b[13]!==m?(v=h({sourceSchemaPreview:m}),b[13]=m,b[14]=v):v=b[14];let N=v;return b[15]!==s?(f={withinPortal:!1,...s},b[15]=s,b[16]=f):f=b[16],b[17]===Symbol.for("react.memo_cache_sentinel")?(S=(0,r.jsx)(l.A,{size:16}),b[17]=S):S=b[17],b[18]!==n||b[19]!==i||b[20]!==N||b[21]!==o||b[22]!==f||b[23]!==_?(y=(0,r.jsx)(c.A,{...i,data:_,comboboxProps:f,searchable:!0,placeholder:"Data Source",leftSection:S,maxDropdownHeight:280,size:o,onCreate:n,...N}),b[18]=n,b[19]=i,b[20]=N,b[21]=o,b[22]=f,b[23]=_,b[24]=y):y=b[24],y})},58153:(e,t,s)=>{"use strict";s.d(t,{A:()=>B});var r,a=s(6029),n=s(75155),i=s(55729),o=s(91715),l=s(43465),c=s(86508),u=s(67549),d=s(83595),m=s(66692),p=s(43517),h=s(37659),g=s(59029),x=s(3635),v=s(63085),f=s(87989),S=s(25062),y=s(20158),b=s(62801),j=s(53993),C=s(34834),_=s(92789),N=s(90124),q=s(38206),E=s(59705),R=s(58061),w=s(78341),D=s(27798),k=s(14105),A=s(57820),P=((r={}).Range="Time range",r.Around="Around a time",r),I=s(75071),M=s(13759);let T=(0,d.tG)("hdx-time-picker-mode",P.Range),z=e=>{let t,s=(0,n.c)(2);return s[0]!==e?(t=(0,a.jsx)(R.J,{size:"xs",highlightToday:!0,placeholder:"YYY-MM-DD HH:mm:ss",valueFormat:"YYYY-MM-DD HH:mm:ss",variant:"filled",dateParser:M.ad,onKeyDown:L,...e}),s[0]=e,s[1]=t):t=s[1],t},$=e=>{let t,s=(0,n.c)(2),{children:r}=e;return s[0]!==r?(t=(0,a.jsx)(p.E,{size:"xxs",c:"dimmed",lh:1.1,children:r}),s[0]=r,s[1]=t):t=s[1],t},B=(0,i.memo)(({inputValue:e,setInputValue:t,onSearch:s,onRelativeSearch:r,onSubmit:d,showLive:R=!1,isLiveMode:B=!1,defaultRelativeTimeMode:L=!1})=>{let{userPreferences:{timeFormat:V}}=(0,A.HW)(),[F,{close:H,toggle:K}]=(0,w.j)(!1);(0,m.vC)("d",()=>K(),{preventDefault:!0},[K]);let Y=i.useMemo(()=>new Date,[]),O=i.useMemo(()=>[...R?[[M.pA,M.e2],"divider"]:[],...M.gw],[R]),[W,G]=(0,u.fp)(T),U=(e=>{let t,s,r=(0,n.c)(3),{mode:a}=e;r[0]===Symbol.for("react.memo_cache_sentinel")?(t={startDate:null,endDate:null,duration:"15m"},r[0]=t):t=r[0],r[1]!==a?(s=e=>{if(a===P.Range&&(!e.startDate||!e.endDate))return{startDate:"Required",endDate:"Required"};if(a===P.Around){if(!e.startDate)return{time:"Required"};if(!e.duration)return{duration:"Required"}}return{}},r[1]=a,r[2]=s):s=r[2];let i=(0,I.m)({mode:"controlled",initialValues:t,validate:s,onValuesChange:e=>{e.endDate&&e.startDate&&e.endDate<e.startDate&&i.setFieldValue("endDate",e.startDate)}});return i})({mode:W}),J=i.useMemo(()=>(0,M.c0)(e),[e]);i.useEffect(()=>{if(!F&&J[0]&&J[1]){if(W===P.Range)U.setValues({startDate:J[0],endDate:J[1]});else if(W===P.Around){let e=new Date((J[0].getTime()+J[1].getTime())/2);U.setFieldValue("startDate",e)}}},[J,F,W]);let X=i.useCallback((e,s)=>{t(e),r?.(s),H()},[H,t,r]),Z=i.useCallback(e=>{if("string"==typeof e){t(e),s(e),H();return}let[r,a]=e;if(!r||!a)return;let n="24h"===V?"MMM d HH:mm:ss":"MMM d h:mm:ss a",i=[r,a].map(e=>e&&(0,o.A)(e,n)).join(" - ");t(i),s(i),H()},[H,t,s,V]),Q=i.useCallback(()=>{if(!U.isValid()||!F)return;let{startDate:e,endDate:t}=U.values;if(W===P.Range&&(Z([e,t]),H()),W===P.Around){let t=M.eh[U.values.duration];Z([e&&(0,l.A)(e,t),e&&(0,c.A)(e,t)]),H()}},[H,U,Z,W,F]);(0,m.vC)("Enter",Q,[Q]);let ee=i.useCallback(e=>{let{startDate:t,endDate:s}=U.values;Z([t&&(0,c.A)(t,e),s&&(0,c.A)(s,e)])},[U.values,Z]),[et,es]=(0,i.useState)(L),[er,ea]=(0,i.useState)(null),en=(0,i.useMemo)(()=>({portalProps:{target:er??void 0}}),[er]);return(0,a.jsxs)(h.A,{position:"bottom-start",closeOnEscape:!0,opened:F,onClose:H,children:[(0,a.jsx)(h.A.Target,{children:(0,a.jsx)(g.k,{"data-testid":"time-picker-input",leftSection:B?(0,a.jsx)(D.A,{size:16,className:"text-brand"}):(0,a.jsx)(k.A,{size:16}),styles:{input:{color:B?"var(--color-text-brand)":"var(--color-text)"}},rightSection:F&&(0,a.jsx)(p.E,{size:"xxs",bg:"var(--color-bg-neutral)",px:4,c:"white",children:"d"}),value:e,onChange:e=>t(e.currentTarget.value),onClick:K,placeholder:"Time Range",size:"sm",w:350,onKeyDown:e=>{"Enter"===e.key&&e.target instanceof HTMLInputElement&&(d?.(e.target.value),H()),"Escape"===e.key&&e.target instanceof HTMLInputElement&&(e.target.blur(),H())}})}),(0,a.jsxs)(h.A.Dropdown,{p:0,"data-testid":"time-picker-popover",ref:ea,children:[(0,a.jsxs)(x.Y,{justify:"space-between",gap:4,px:"xs",py:4,children:[(0,a.jsx)(x.Y,{gap:4,children:"function"==typeof r&&(0,a.jsx)(v.m,{label:"Set how far back Live Tail begins streaming logs.",refProp:"rootRef",children:(0,a.jsx)(f.d,{"data-testid":"time-picker-relative-switch",size:"xs",checked:et,onChange:e=>es(e.currentTarget.checked),label:"Relative Time",labelPosition:"right",styles:{label:{paddingLeft:"5px"}}})})}),(0,a.jsxs)(x.Y,{gap:4,children:[(0,a.jsx)(S.$,{"data-testid":"time-picker-1h-back",size:"compact-xs",variant:"secondary",onClick:ee.bind(null,{hours:-1}),disabled:B||et,children:"1h back"}),(0,a.jsx)(S.$,{"data-testid":"time-picker-1h-forward",size:"compact-xs",variant:"secondary",onClick:ee.bind(null,{hours:1}),disabled:B||et,children:"1h forward"}),(0,a.jsx)(y.J,{"data-testid":"time-picker-close",onClick:H})]})]}),(0,a.jsxs)(x.Y,{gap:1,align:"stretch",children:[(0,a.jsx)(b.Z,{w:180,p:0,children:(0,a.jsx)(j.F,{h:300,scrollbarSize:5,children:(0,a.jsx)(C.B,{gap:0,p:"xs",children:O.map((t,s)=>"divider"===t?(0,a.jsx)(_.c,{my:4},s):(0,a.jsx)(S.$,{disabled:et&&!t[2]&&t[0]!==M.pA,onClick:()=>{et||t[0]===M.pA?X?.(t[0],t[1]):Z(t[0])},w:"100%",size:"compact-xs",color:"gray",variant:e===t[0]?"filled":"subtle",fw:"normal",fz:"xs",fullWidth:!0,justify:"space-between",children:t[0]},t[0]))})})}),(0,a.jsxs)(b.Z,{w:280,p:"xs",children:[(0,a.jsxs)(C.B,{gap:8,mb:"sm",children:[(0,a.jsx)(N.I,{size:"xs",mb:"xs",data:[P.Range,P.Around],value:W,disabled:et,onChange:e=>{if(G(e),e===P.Around&&U.values.startDate&&U.values.endDate){let e=new Date((U.values.startDate.getTime()+U.values.endDate.getTime())/2),t=(U.values.endDate.getTime()-U.values.startDate.getTime())/2/6e4,s="15m";s=t<=.5?"30s":t<=1?"1m":t<=5?"5m":t<=15?"15m":t<=30?"30m":t<=60?"1h":t<=180?"3h":t<=360?"6h":"12h",U.setValues({startDate:e,duration:s})}}}),W===P.Range?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)($,{children:"Start time"}),(0,a.jsx)(z,{disabled:et,popoverProps:en,maxDate:Y,mb:"xs",...U.getInputProps("startDate")}),(0,a.jsx)($,{children:"End time"}),(0,a.jsx)(z,{popoverProps:en,maxDate:Y,minDate:U.values.startDate??void 0,disabled:et,...U.getInputProps("endDate")})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)($,{children:"Time"}),(0,a.jsx)(z,{disabled:et,popoverProps:en,maxDate:Y,mb:"xs",...U.getInputProps("startDate")}),(0,a.jsx)($,{children:"Duration \xb1"}),(0,a.jsx)(q.l,{placeholder:"Pick value",data:M.U$,comboboxProps:en,searchable:!0,size:"xs",disabled:et,variant:"filled",...U.getInputProps("duration")})]})]}),(0,a.jsx)(p.E,{size:"xxs",lh:1.2,children:"You can use natural language to select dates (e.g. yesterday, last monday at 5pm)"}),(0,a.jsx)(E.$,{flex:1}),(0,a.jsx)(x.Y,{justify:"flex-end",mt:8,pt:8,style:{borderTop:"1px solid var(--color-border)"},children:(0,a.jsx)(S.$,{"data-testid":"time-picker-apply",size:"compact-sm",variant:"primary",disabled:!U.isValid()||et,onClick:Q,children:"Apply"})})]})]})]})]})});function L(e){"Enter"===e.key&&e.target instanceof HTMLInputElement&&e.target.blur()}},89011:e=>{e.exports={sourceSchemaPreviewButton:"SourceSelectControlled_sourceSchemaPreviewButton__qKlsK"}},89962:e=>{e.exports={container:"ServiceMap_container__gQ6W_",toolbar:"ServiceMap_toolbar__ORSDP",serviceNode:"ServiceMap_serviceNode__ixi_4",body:"ServiceMap_body___HL8_",circle:"ServiceMap_circle__N0cV2"}},98287:(e,t,s)=>{"use strict";s.d(t,{A:()=>V});var r=s(6029),a=s(75155),n=s(55729),i=s(56992),o=s.n(i),l=s(35467),c=s(53061),u=s(94720),d=s(43517),m=s(24589),p=s(60481),h=s(60665),g=s(57703),x=s(22476),v=s(80519),f=s.n(v),S=s(67270),y=s(12482),b=s(49672),j=s(78550);async function C({source:e,dateRange:t,traceId:s,metadata:r,samplingFactor:a}){let n=s?1:a,i={from:e.from,connection:e.connection,dateRange:t,timestampValueExpression:e.timestampValueExpression,filters:[{type:"sql",condition:`cityHash64(${e.traceIdExpression}) % ${n} = 0`},...s?[{type:"sql",condition:f().format("?? = ?",[e.traceIdExpression,s])}]:[]],select:[{valueExpression:e.traceIdExpression??"TraceId",alias:"traceId"},{valueExpression:e.spanIdExpression??"SpanId",alias:"spanId"},{valueExpression:e.serviceNameExpression??"ServiceName",alias:"serviceName"},{valueExpression:e.parentSpanIdExpression??"ParentSpanId",alias:"parentSpanId"},{valueExpression:e.statusCodeExpression??"StatusCode",alias:"statusCode"}]},[o,c]=await Promise.all([(0,S.PV)({...i,filters:[...i.filters,{type:"sql",condition:`${e.spanKindExpression} IN ('Server', 'Consumer', 'SPAN_KIND_SERVER', 'SPAN_KIND_CONSUMER')`}],where:""},r,e.querySettings),(0,S.PV)({...i,filters:[...i.filters,{type:"sql",condition:`${e.spanKindExpression} IN ('Client', 'Producer', 'SPAN_KIND_CLIENT', 'SPAN_KIND_PRODUCER')`}],where:""},r,e.querySettings)]);return(0,l.kg)`
    WITH 
      ServerSpans AS (${o}),
      ClientSpans AS (${c})
    SELECT
      ServerSpans.serviceName AS serverServiceName,
      ServerSpans.statusCode AS serverStatusCode,
      ClientSpans.serviceName AS clientServiceName,
      count(*) * ${{Int64:n}} as requestCount
    FROM ServerSpans
      LEFT JOIN ClientSpans
        ON ServerSpans.traceId = ClientSpans.traceId
        AND ServerSpans.parentSpanId = ClientSpans.spanId
    WHERE (ClientSpans.serviceName IS NULL OR ServerSpans.serviceName != ClientSpans.serviceName)
    GROUP BY serverServiceName, serverStatusCode, clientServiceName
    ORDER BY serverServiceName, serverStatusCode, clientServiceName
  `}function _(e){return e.data.map(N)}function N(e){return{serverServiceName:e.serverServiceName,serverStatusCode:e.serverStatusCode,clientServiceName:e.clientServiceName,requestCount:Number.parseInt(e.requestCount)}}function q(e){return e.json()}var E=s(88339),R=s(25062),w=s(34834),D=s(41279),k=s(81278),A=s.n(k);function P({dateRange:e,source:t,where:s}){let r=e[0].getTime().toString(),a=e[1].getTime().toString(),n=new URLSearchParams({isLive:"false",source:t?.id,where:s,whereLanguage:"sql",from:r,to:a});A().push(`/search?${n.toString()}`)}var I=s(89962),M=s.n(I);function T(e){let t,s,n,i,o,l,c,u,d=(0,a.c)(24),{totalRequests:m,errorPercentage:p,source:h,dateRange:g,serviceName:x,isSingleTrace:v}=e;d[0]!==v||d[1]!==m?(t=v?m:function(e){if(e<1e3)return`~${e.toString()}`;if(e<1e6){let t=e/1e3;return`~${Math.round(t)}k`}if(e<1e9){let t=e/1e6;return`~${Math.round(t)}M`}let t=e/1e9;return`~${Math.round(t)}B`}(m),d[0]=v,d[1]=m,d[2]=t):t=d[2];let S=`${t} request${1!==m?"s":""}`;d[3]!==p?(s=p.toFixed(2),d[3]=p,d[4]=s):s=d[4];let y=`${s}% errors`;d[5]!==g||d[6]!==x||d[7]!==h?(n=()=>{P({dateRange:g,source:h,where:f().format("? = ? AND ? IN ('Server', 'Consumer')",[f().raw(h.serviceNameExpression??"ServiceName"),x,f().raw(h.spanKindExpression??"SpanKind")])})},d[5]=g,d[6]=x,d[7]=h,d[8]=n):n=d[8];let b=n;d[9]!==g||d[10]!==x||d[11]!==h?(i=()=>{P({dateRange:g,source:h,where:f().format("? = ? AND ? IN ('Server', 'Consumer') AND ? = 'Error'",[f().raw(h.serviceNameExpression??"ServiceName"),x,f().raw(h.spanKindExpression??"SpanKind"),f().raw(h.statusCodeExpression??"StatusCode")])})},d[9]=g,d[10]=x,d[11]=h,d[12]=i):i=d[12];let j=i;return d[13]===Symbol.for("react.memo_cache_sentinel")?(o=(0,r.jsx)(D.A,{size:16}),d[13]=o):o=d[13],d[14]!==b||d[15]!==S?(l=(0,r.jsx)(R.$,{onClick:b,variant:"subtle",size:"xs",color:"var(--color-text)",rightSection:o,children:S}),d[14]=b,d[15]=S,d[16]=l):l=d[16],d[17]!==p||d[18]!==y||d[19]!==j?(c=p>0?(0,r.jsx)(r.Fragment,{children:(0,r.jsx)(R.$,{onClick:j,variant:"subtle",size:"xs",color:"var(--color-text-danger)",rightSection:(0,r.jsx)(D.A,{size:16}),children:y})}):null,d[17]=p,d[18]=y,d[19]=j,d[20]=c):c=d[20],d[21]!==l||d[22]!==c?(u=(0,r.jsxs)(w.B,{className:M().toolbar,gap:0,children:[l,c]}),d[21]=l,d[22]=c,d[23]=u):u=d[23],u}let z={service:function(e){let t,s,n,i,o,l,c,u,m,p,h=(0,a.c)(27),{data:v}=e,{serviceName:f,incomingRequests:S,source:y,dateRange:b,maxErrorPercentage:j,isSingleTrace:C}=v,{totalRequests:_,errorPercentage:N}=S;if(h[0]!==N||h[1]!==j||h[2]!==e.selected){var q;let s;q=e.selected,s=j>0?Math.min(N,j)/j*100:0,t={backgroundColor:`hsl(0 ${s}% 80%)`,borderColor:q?"white":`hsl(0 ${s}% 40%)`},h[0]=N,h[1]=j,h[2]=e.selected,h[3]=t}else t=h[3];let{backgroundColor:E,borderColor:R}=t;return h[4]!==b||h[5]!==N||h[6]!==C||h[7]!==f||h[8]!==y||h[9]!==_?(s=(0,r.jsx)(x.ER,{position:g.yX.Top,align:"center",children:(0,r.jsx)(T,{errorPercentage:N,totalRequests:_,source:y,dateRange:b,serviceName:f,isSingleTrace:C})}),h[4]=b,h[5]=N,h[6]=C,h[7]=f,h[8]=y,h[9]=_,h[10]=s):s=h[10],h[11]===Symbol.for("react.memo_cache_sentinel")?(n=(0,r.jsx)("div",{className:"position-relative",children:(0,r.jsx)(x.h7,{type:"target",position:g.yX.Left,style:{visibility:"hidden",marginLeft:3}})}),h[11]=n):n=h[11],h[12]!==E||h[13]!==R?(i=(0,r.jsx)("div",{className:M().circle,style:{backgroundColor:E,borderColor:R}}),h[12]=E,h[13]=R,h[14]=i):i=h[14],h[15]===Symbol.for("react.memo_cache_sentinel")?(o={marginLeft:-3},h[15]=o):o=h[15],h[16]===Symbol.for("react.memo_cache_sentinel")?(l=(0,r.jsx)("div",{className:"position-relative",style:o,children:(0,r.jsx)(x.h7,{type:"source",position:g.yX.Right,style:{visibility:"hidden"}})}),h[16]=l):l=h[16],h[17]!==i?(c=(0,r.jsxs)("div",{className:M().body,children:[n,i,l]}),h[17]=i,h[18]=c):c=h[18],h[19]!==f?(u=(0,r.jsx)(d.E,{size:"xxs",children:f}),h[19]=f,h[20]=u):u=h[20],h[21]!==c||h[22]!==u?(m=(0,r.jsxs)("div",{className:`${M().serviceNode}`,children:[c,u]}),h[21]=c,h[22]=u,h[23]=m):m=h[23],h[24]!==s||h[25]!==m?(p=(0,r.jsxs)(r.Fragment,{children:[s,m]}),h[24]=s,h[25]=m,h[26]=p):p=h[26],p}},$={request:function(e){let t,s,n,i,o,l=(0,a.c)(21);l[0]!==e?(t=(0,g.Fp)(e),l[0]=e,l[1]=t):t=l[1];let[c,u,d]=t;if(!e.data)return null;let{totalRequests:m,errorPercentage:p,dateRange:h,serviceName:v,source:f,isSingleTrace:S}=e.data;return l[2]!==c||l[3]!==e.id?(s=(0,r.jsx)(x.tE,{id:e.id,path:c}),l[2]=c,l[3]=e.id,l[4]=s):s=l[4],l[5]!==h||l[6]!==p||l[7]!==S||l[8]!==v||l[9]!==f||l[10]!==m?(n=(0,r.jsx)(T,{totalRequests:m,errorPercentage:p,source:f,dateRange:h,serviceName:v,isSingleTrace:S}),l[5]=h,l[6]=p,l[7]=S,l[8]=v,l[9]=f,l[10]=m,l[11]=n):n=l[11],l[12]!==u||l[13]!==d||l[14]!==e.id||l[15]!==e.selected||l[16]!==n?(i=(0,r.jsx)(x.dN,{edgeId:e.id,x:u,y:d,isVisible:e.selected,children:n}),l[12]=u,l[13]=d,l[14]=e.id,l[15]=e.selected,l[16]=n,l[17]=i):i=l[17],l[18]!==s||l[19]!==i?(o=(0,r.jsxs)(r.Fragment,{children:[s,i]}),l[18]=s,l[19]=i,l[20]=o):o=l[20],o}};function B(e){let t,s,i,h,v,f,S,y,b,j,C,_,N=(0,a.c)(36),{services:q,isLoading:R,error:w,dateRange:D,source:k,isSingleTrace:A}=e;N[0]===Symbol.for("react.memo_cache_sentinel")?(t=[],N[0]=t):t=N[0];let[P,I]=(0,n.useState)(t);N[1]===Symbol.for("react.memo_cache_sentinel")?(s=[],N[1]=s):s=N[1];let[T,B]=(0,n.useState)(s),{fitView:V}=(0,x.VH)();N[2]!==V?(i=()=>{V()},N[2]=V,N[3]=i):i=N[3],N[4]!==V||N[5]!==q?(h=[V,q],N[4]=V,N[5]=q,N[6]=h):h=N[6],(0,n.useEffect)(i,h),N[7]===Symbol.for("react.memo_cache_sentinel")?(v=e=>I(t=>(0,x._0)(e,t)),N[7]=v):v=N[7];let F=v;N[8]===Symbol.for("react.memo_cache_sentinel")?(f=e=>B(t=>(0,x.zW)(e,t)),N[8]=f):f=N[8];let H=f,K=0;if(N[9]!==K||N[10]!==q){for(let e of q?.values()??[])K=Math.max(e.incomingRequests.errorPercentage,K);N[9]=K,N[10]=q,N[11]=K}else K=N[11];let Y=K;if(N[12]!==D||N[13]!==A||N[14]!==Y||N[15]!==q||N[16]!==k?(S=()=>{let e=Array.from(q?.values()??[]).map((e,t)=>({id:e.serviceName,data:{...e,dateRange:D,source:k,maxErrorPercentage:Y,isSingleTrace:A},position:{x:150*t,y:100},type:"service"}))??[],t=Array.from(q?.values()??[]).filter(L).flatMap(e=>{let{serviceName:t,incomingRequestsByClient:s}=e;return Array.from(s.entries()).map(e=>{let[s,r]=e,{totalRequests:a,errorPercentage:n}=r;return{id:`${t}-${s}`,source:s,target:t,animated:!0,type:"request",data:{totalRequests:a,errorPercentage:n,source:k,dateRange:D,serviceName:t,isSingleTrace:A}}})});I(function(e,t){let s=new(o()).graphlib.Graph().setDefaultEdgeLabel(()=>({}));for(let t of(s.setGraph({rankdir:"LR"}),e))s.setNode(t.id,{width:80,height:40});for(let e of t)s.setEdge(e.source,e.target);return o().layout(s),e.map(e=>{let t=s.node(e.id);return{...e,targetPosition:g.yX.Left,sourcePosition:g.yX.Right,position:{x:t.x-40,y:t.y-40}}})}(e,t)),B(t)},y=[q,D,k,Y,A],N[12]=D,N[13]=A,N[14]=Y,N[15]=q,N[16]=k,N[17]=S,N[18]=y):(S=N[17],y=N[18]),(0,n.useEffect)(S,y),R){let e;return N[19]===Symbol.for("react.memo_cache_sentinel")?(e=(0,r.jsx)(c.o,{className:`${M().graphContainer} h-100 w-100`,children:(0,r.jsx)(u.a,{size:"lg"})}),N[19]=e):e=N[19],e}if(q&&0===q.size){let e;return N[20]===Symbol.for("react.memo_cache_sentinel")?(e=(0,r.jsx)(c.o,{className:"w-100 h-100",children:(0,r.jsx)(d.E,{size:"sm",c:"gray.5",children:"No services found. The Service Map shows links between services with related Client- and Server-kind spans."})}),N[20]=e):e=N[20],e}if(w){let e,t,s,a,n;N[21]===Symbol.for("react.memo_cache_sentinel")?(e=(0,r.jsx)(d.E,{my:"sm",size:"sm",children:"Error message:"}),N[21]=e):e=N[21],N[22]===Symbol.for("react.memo_cache_sentinel")?(t={whiteSpace:"pre-wrap"},N[22]=t):t=N[22];let i=w?.message;return N[23]!==i?(s=(0,r.jsx)(m.C,{block:!0,style:t,children:i}),N[23]=i,N[24]=s):s=N[24],N[25]!==w?(a=w instanceof l.p1&&(0,r.jsxs)(p.a,{mt:"lg",children:[(0,r.jsx)(d.E,{my:"sm",size:"sm",children:"Original query:"}),(0,r.jsx)(m.C,{block:!0,style:{whiteSpace:"pre-wrap"},children:(0,r.jsx)(E.V,{data:w.query,formatData:!0})})]}),N[25]=w,N[26]=a):a=N[26],N[27]!==s||N[28]!==a?(n=(0,r.jsxs)(p.a,{children:[e,s,a]}),N[27]=s,N[28]=a,N[29]=n):n=N[29],n}return N[30]===Symbol.for("react.memo_cache_sentinel")?(b={backgroundColor:"inherit"},N[30]=b):b=N[30],N[31]===Symbol.for("react.memo_cache_sentinel")?(j={hideAttribution:!0},C=(0,r.jsx)(x.H2,{showInteractive:!1}),N[31]=j,N[32]=C):(j=N[31],C=N[32]),N[33]!==T||N[34]!==P?(_=(0,r.jsx)("div",{className:M().container,children:(0,r.jsx)(x.Gc,{style:b,nodes:P,edges:T,onNodesChange:F,onEdgesChange:H,nodeTypes:z,edgeTypes:$,fitView:!0,colorMode:"dark",proOptions:j,children:C})}),N[33]=T,N[34]=P,N[35]=_):_=N[35],_}function L(e){return e.incomingRequestsByClient.size>0}function V(e){let t,s,i,o,l=(0,a.c)(15),{traceId:c,traceTableSource:u,dateRange:d,samplingFactor:m,isSingleTrace:p}=e,g=void 0===m?1:m;l[0]!==d||l[1]!==g||l[2]!==c||l[3]!==u?(t={traceId:c,source:u,dateRange:d,samplingFactor:g},l[0]=d,l[1]=g,l[2]=c,l[3]=u,l[4]=t):t=l[4];let{isLoading:v,data:f,error:S}=function(e){let t,s,r,n=(0,a.c)(15),{source:i,dateRange:o,traceId:l,samplingFactor:c}=e,u=(0,b.fu)(),d=(0,j.Ge)();return n[0]!==o||n[1]!==c||n[2]!==i||n[3]!==l?(t=["serviceMapData",l,i,o,c],n[0]=o,n[1]=c,n[2]=i,n[3]=l,n[4]=t):t=n[4],n[5]!==u||n[6]!==o||n[7]!==d||n[8]!==c||n[9]!==i||n[10]!==l?(s=async e=>{let{signal:t}=e,s=await C({source:i,dateRange:o,traceId:l,metadata:d,samplingFactor:c});return function(e){let t=new Map;for(let s of e){let{serverServiceName:e,serverStatusCode:r,clientServiceName:a,requestCount:n}=s;t.has(e)||t.set(e,{serviceName:e,incomingRequests:{totalRequests:0,requestCountByStatus:new Map,errorPercentage:0},incomingRequestsByClient:new Map});let i=t.get(e);i.incomingRequests.totalRequests+=n;let o=i.incomingRequests.requestCountByStatus.get(r)||0;if(i.incomingRequests.requestCountByStatus.set(r,o+n),a){i.incomingRequestsByClient.has(a)||i.incomingRequestsByClient.set(a,{totalRequests:0,requestCountByStatus:new Map,errorPercentage:0});let e=i.incomingRequestsByClient.get(a);e.totalRequests+=n;let s=e.requestCountByStatus.get(r)||0;e.requestCountByStatus.set(r,s+n),t.has(a)||t.set(a,{serviceName:a,incomingRequests:{totalRequests:0,requestCountByStatus:new Map,errorPercentage:0},incomingRequestsByClient:new Map})}}for(let e of t.values()){let t=e.incomingRequests.requestCountByStatus.get("Error")||0;for(let s of(e.incomingRequests.errorPercentage=e.incomingRequests.totalRequests>0?t/e.incomingRequests.totalRequests*100:0,e.incomingRequestsByClient.values())){let e=s.requestCountByStatus.get("Error")||0;s.errorPercentage=s.totalRequests>0?e/s.totalRequests*100:0}}return t}(await u.query({query:s.sql,query_params:s.params,connectionId:i.connection,format:"JSON",abort_signal:t,clickhouse_settings:{max_execution_time:60,join_algorithm:"auto"}}).then(q).then(_))},n[5]=u,n[6]=o,n[7]=d,n[8]=c,n[9]=i,n[10]=l,n[11]=s):s=n[11],n[12]!==t||n[13]!==s?(r={queryKey:t,queryFn:s,staleTime:1/0,refetchOnWindowFocus:!1,retry:1},n[12]=t,n[13]=s,n[14]=r):r=n[14],(0,y.I)(r)}(t);return l[5]!==S?(s=()=>{S&&h.$e.show({title:"Error loading service map",message:S.message,color:"red"})},i=[S],l[5]=S,l[6]=s,l[7]=i):(s=l[6],i=l[7]),(0,n.useEffect)(s,i),l[8]!==d||l[9]!==S||l[10]!==v||l[11]!==p||l[12]!==f||l[13]!==u?(o=(0,r.jsx)(x.Ln,{children:(0,r.jsx)(B,{services:f,isLoading:v,error:S,dateRange:d,source:u,isSingleTrace:p})}),l[8]=d,l[9]=S,l[10]=v,l[11]=p,l[12]=f,l[13]=u,l[14]=o):o=l[14],o}}}]);